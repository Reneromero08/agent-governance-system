#!/bin/sh
# Pre-push hook - blocks push without approval token
set -e

# Cross-platform Python detection
if python3 --version >/dev/null 2>&1; then
    PYTHON_CMD="python3"
elif python --version >/dev/null 2>&1; then
    PYTHON_CMD="python"
else
    echo "[PRE-PUSH] ERROR: No Python found"
    exit 1
fi

TOKEN_FILE="LAW/CONTRACTS/_runs/ALLOW_PUSH.token"

# Check if pushing release tags - verify seal (Crypto Safe)
# Read stdin for refs being pushed
while read local_ref local_sha remote_ref remote_sha; do
    # Check if this is a version tag (v*)
    if echo "$remote_ref" | grep -qE '^refs/tags/v[0-9]'; then
        TAG_NAME=$(echo "$remote_ref" | sed 's|refs/tags/||')
        echo "[PRE-PUSH] Release tag detected: $TAG_NAME"
        echo "[PRE-PUSH] Verifying release seal..."

        # Check if manifest exists in versioned location
        SEAL_DIR="NAVIGATION/PROOFS/RELEASES/$TAG_NAME"
        if [ ! -f "$SEAL_DIR/RELEASE_MANIFEST.json" ]; then
            echo ""
            echo "[PRE-PUSH] ERROR: Release tag push blocked - no seal found!"
            echo ""
            echo "  Before pushing a release tag, you must seal the repository:"
            echo ""
            echo "    python -m CAPABILITY.TOOLS.catalytic.seal_release seal --repo-dir . --version $TAG_NAME"
            echo "    git add $SEAL_DIR/"
            echo "    git commit -m \"Seal release $TAG_NAME\""
            echo ""
            exit 1
        fi

        # Verify the seal
        if ! $PYTHON_CMD -m CAPABILITY.TOOLS.catalytic.verify_release --repo-dir . --version "$TAG_NAME" 2>/dev/null; then
            echo ""
            echo "[PRE-PUSH] ERROR: Release tag push blocked - seal verification FAILED!"
            echo ""
            echo "  The repository state does not match the seal."
            echo "  Re-seal the repository before pushing the release tag:"
            echo ""
            echo "    python -m CAPABILITY.TOOLS.catalytic.seal_release seal --repo-dir . --version $TAG_NAME"
            echo "    git add $SEAL_DIR/"
            echo "    git commit --amend  # or new commit"
            echo ""
            exit 1
        fi

        echo "[PRE-PUSH] Release seal verified for $TAG_NAME"
    fi
done

echo "[PRE-PUSH] Checking push approval..."

# Check if token exists
if [ ! -f "$TOKEN_FILE" ]; then
    echo ""
    echo "❌ PUSH BLOCKED: No push approval token found"
    echo ""
    echo "Recommended (full CI-aligned gate + token):"
    echo "  python CAPABILITY/TOOLS/utilities/ci_local_gate.py --full"
    echo ""
    echo "Legacy/manual token (will run full gate on push):"
    echo "  echo \"my-push-reason\" > $TOKEN_FILE"
    echo ""
    exit 1
fi

# Read token
TOKEN_SCOPE=$(cat "$TOKEN_FILE")
echo "[PRE-PUSH] Token found: $TOKEN_SCOPE"
echo "The token will be consumed (deleted) after successful push."

# If this is a CI_OK token, validate it matches current HEAD and skip re-running checks.
echo "$TOKEN_SCOPE" | grep -q "CI_OK" && CI_OK=1 || CI_OK=0
if [ "$CI_OK" -eq 1 ]; then
    HEAD=$(git rev-parse HEAD 2>/dev/null || true)
    TOK_HEAD=$(echo "$TOKEN_SCOPE" | sed -n 's/.*head=\([0-9a-f]\{40\}\).*/\1/p')

    if [ -z "$TOK_HEAD" ] || [ -z "$HEAD" ] || [ "$TOK_HEAD" != "$HEAD" ]; then
        echo ""
        echo "❌ PUSH BLOCKED: CI_OK token does not match current HEAD"
        echo "  token head: $TOK_HEAD"
        echo "  current:    $HEAD"
        echo ""
        echo "Re-run: python CAPABILITY/TOOLS/utilities/ci_local_gate.py --full"
        echo ""
        exit 1
    fi

    # Safety: prevent pushing while the index has staged-but-uncommitted changes.
    if ! git diff --cached --quiet; then
        echo ""
        echo "❌ PUSH BLOCKED: staged changes are not committed"
        echo "Commit (or unstage) changes before pushing."
        echo ""
        exit 1
    fi
    # Note: working tree can be dirty without affecting the pushed commit; we don't block on that.
else
    # Legacy/manual token: run the full CI-aligned gate on push (slower, but CI-aligned).
    echo "[PRE-PUSH] Running full CI-aligned gate (critic + runner + pytest)..."
    python CAPABILITY/TOOLS/utilities/ci_local_gate.py --full
    if [ $? -ne 0 ]; then
        echo ""
        echo "❌ PUSH BLOCKED: CI-aligned gate failed"
        echo ""
        echo "Fix failing checks before pushing."
        echo "Token preserved for retry."
        echo ""
        exit 1
    fi

    echo "[PRE-PUSH] ✅ CI-aligned gate passed"
fi

echo "[PRE-PUSH] ✅ Push approved - consuming token"

# Delete token (one-time use)
rm "$TOKEN_FILE"

echo "[PRE-PUSH] Proceeding with push..."
exit 0
