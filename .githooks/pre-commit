#!/bin/sh
set -e

# Cross-platform Python detection
if python3 --version >/dev/null 2>&1; then
    PYTHON_CMD="python3"
elif python --version >/dev/null 2>&1; then
    PYTHON_CMD="python"
else
    echo "[PRE-COMMIT] ERROR: No Python found"
    exit 1
fi

# Block private key commits (Crypto Safe)
echo "[PRE-COMMIT] Checking for private keys..."
if git diff --cached --name-only | grep -E '\.key$' | grep -v '\.pub\.key$'; then
    echo ""
    echo "[PRE-COMMIT] ERROR: Private key file staged for commit!"
    echo "             Signing keys must NEVER be committed to the repository."
    echo ""
    echo "  Unstage with: git reset HEAD <file>.key"
    echo ""
    exit 1
fi

echo "[PRE-COMMIT] Running preflight..."
$PYTHON_CMD CAPABILITY/TOOLS/ags.py preflight --allow-dirty-tracked

echo "[PRE-COMMIT] Running canon governance check..."
node CAPABILITY/TOOLS/check-canon-governance.js

echo "[PRE-COMMIT] Running INBOX policy check..."
$PYTHON_CMD CAPABILITY/SKILLS/inbox/inbox-report-writer/check_inbox_policy.py

echo "[PRE-COMMIT] OK"
