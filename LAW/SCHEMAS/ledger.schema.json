{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "ledger.schema.json",
  "id": "ledger.schema.json",
  "title": "CAT-DPT Run Ledger (Logical)",
  "type": "object",
  "additionalProperties": false,
  "$comment": "CAT-DPT Phase 0 contract schema. Logical ledger object; may be stored as multiple files on disk. APPEND-ONLY: once a ledger entry is written, it must never be modified or deleted.",
  "required": [
    "RUN_INFO",
    "PRE_MANIFEST",
    "POST_MANIFEST",
    "RESTORE_DIFF",
    "OUTPUTS",
    "STATUS"
  ],
  "properties": {
    "JOBSPEC": {
      "$ref": "jobspec.schema.json"
    },
    "RUN_INFO": {
      "$ref": "ledger.schema.json#/definitions/run_info"
    },
    "PRE_MANIFEST": {
      "$ref": "ledger.schema.json#/definitions/manifest"
    },
    "POST_MANIFEST": {
      "$ref": "ledger.schema.json#/definitions/manifest"
    },
    "RESTORE_DIFF": {
      "$ref": "ledger.schema.json#/definitions/restore_diff"
    },
    "OUTPUTS": {
      "$ref": "ledger.schema.json#/definitions/outputs"
    },
    "STATUS": {
      "$ref": "ledger.schema.json#/definitions/status"
    },
    "VALIDATOR_ID": {
      "$ref": "ledger.schema.json#/definitions/validator_id"
    }
  },
  "definitions": {
    "sha256": {
      "type": "string",
      "pattern": "^[a-f0-9]{64}$"
    },
    "run_info": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "run_id",
        "timestamp",
        "intent",
        "catalytic_domains",
        "exit_code",
        "restoration_verified"
      ],
      "properties": {
        "run_id": {
          "type": "string",
          "minLength": 1
        },
        "timestamp": {
          "type": "string",
          "minLength": 1
        },
        "intent": {
          "type": "string",
          "minLength": 1
        },
        "catalytic_domains": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          }
        },
        "exit_code": {
          "type": "integer"
        },
        "restoration_verified": {
          "type": "boolean"
        }
      }
    },
    "manifest": {
      "type": "object",
      "description": "Map: domain -> {relative_path -> sha256}.",
      "additionalProperties": {
        "type": "object",
        "additionalProperties": {
          "$ref": "ledger.schema.json#/definitions/sha256"
        }
      }
    },
    "restore_diff": {
      "type": "object",
      "description": "Map: domain -> {added, removed, changed} where each is {path -> sha256}.",
      "additionalProperties": {
        "type": "object",
        "additionalProperties": false,
        "required": [
          "added",
          "removed",
          "changed"
        ],
        "properties": {
          "added": {
            "type": "object",
            "additionalProperties": {
              "$ref": "ledger.schema.json#/definitions/sha256"
            }
          },
          "removed": {
            "type": "object",
            "additionalProperties": {
              "$ref": "ledger.schema.json#/definitions/sha256"
            }
          },
          "changed": {
            "type": "object",
            "additionalProperties": {
              "$ref": "ledger.schema.json#/definitions/sha256"
            }
          }
        }
      }
    },
    "outputs": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": [
          "path",
          "type"
        ],
        "properties": {
          "path": {
            "type": "string",
            "minLength": 1
          },
          "type": {
            "type": "string",
            "enum": [
              "file",
              "directory"
            ]
          },
          "sha256": {
            "$ref": "ledger.schema.json#/definitions/sha256"
          }
        }
      }
    },
    "status": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "status",
        "restoration_verified"
      ],
      "properties": {
        "status": {
          "type": "string",
          "minLength": 1
        },
        "restoration_verified": {
          "type": "boolean"
        },
        "exit_code": {
          "type": "integer"
        },
        "validation_passed": {
          "type": "boolean"
        }
      }
    },
    "validator_id": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "validator_semver",
        "validator_build_id"
      ],
      "properties": {
        "validator_semver": {
          "type": "string",
          "minLength": 1
        },
        "validator_build_id": {
          "type": "string",
          "minLength": 1
        }
      }
    }
  }
}
