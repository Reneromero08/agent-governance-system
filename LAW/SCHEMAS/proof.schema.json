{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "proof.schema.json",
  "$comment": "CAT-DPT Restoration Proof Protocol. Artifact-only verification structure. IMMUTABLE: once generated, proof must never be modified.",
  "title": "CAT-DPT Restoration Proof",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "proof_version",
    "run_id",
    "timestamp",
    "catalytic_domains",
    "pre_state",
    "post_state",
    "restoration_result",
    "proof_hash"
  ],
  "properties": {
    "proof_version": {
      "type": "string",
      "const": "1.0.0",
      "description": "Protocol version. Must be exactly '1.0.0' for this schema."
    },
    "run_id": {
      "type": "string",
      "minLength": 1,
      "description": "Unique identifier linking this proof to a specific run."
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp of proof generation."
    },
    "catalytic_domains": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "string",
        "minLength": 1
      },
      "description": "List of domain roots that were subject to restoration verification."
    },
    "pre_state": {
      "$ref": "#/definitions/domain_state",
      "description": "Snapshot of domain state before run execution."
    },
    "post_state": {
      "$ref": "#/definitions/domain_state",
      "description": "Snapshot of domain state after restoration."
    },
    "restoration_result": {
      "$ref": "#/definitions/restoration_result",
      "description": "Verification outcome with explicit success or failure semantics."
    },
    "proof_hash": {
      "$ref": "#/definitions/sha256",
      "description": "SHA-256 hash of this proof object excluding the proof_hash field itself. Computed over canonical JSON (sorted keys, no whitespace)."
    },
    "referenced_artifacts": {
      "$ref": "#/definitions/referenced_artifacts",
      "description": "Optional explicit list of artifacts required for offline verification."
    }
  },
  "definitions": {
    "sha256": {
      "type": "string",
      "pattern": "^[a-f0-9]{64}$",
      "description": "Lowercase hex-encoded SHA-256 hash (64 characters)."
    },
    "domain_state": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "domain_root_hash",
        "file_manifest"
      ],
      "properties": {
        "domain_root_hash": {
          "$ref": "#/definitions/sha256",
          "description": "Merkle root or aggregate hash of all files in domain."
        },
        "file_manifest": {
          "type": "object",
          "additionalProperties": {
            "$ref": "#/definitions/sha256"
          },
          "description": "Map: relative_path -> sha256 hash of file contents."
        }
      }
    },
    "restoration_result": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "verified",
        "condition"
      ],
      "properties": {
        "verified": {
          "type": "boolean",
          "description": "True if and only if all verification conditions passed."
        },
        "condition": {
          "type": "string",
          "enum": [
            "RESTORED_IDENTICAL",
            "RESTORATION_FAILED_HASH_MISMATCH",
            "RESTORATION_FAILED_MISSING_FILES",
            "RESTORATION_FAILED_EXTRA_FILES",
            "RESTORATION_FAILED_DOMAIN_UNREACHABLE"
          ],
          "description": "Explicit verification outcome. RESTORED_IDENTICAL is the only success condition."
        },
        "mismatches": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/mismatch_entry"
          },
          "description": "Required when condition is not RESTORED_IDENTICAL. Lists all verification failures."
        }
      },
      "allOf": [
        {
          "if": {
            "properties": {
              "condition": {
                "const": "RESTORED_IDENTICAL"
              }
            }
          },
          "then": {
            "properties": {
              "verified": {
                "const": true
              }
            }
          }
        },
        {
          "if": {
            "properties": {
              "condition": {
                "not": {
                  "const": "RESTORED_IDENTICAL"
                }
              }
            }
          },
          "then": {
            "properties": {
              "verified": {
                "const": false
              }
            },
            "required": [
              "verified",
              "condition",
              "mismatches"
            ]
          }
        }
      ]
    },
    "mismatch_entry": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "path",
        "type"
      ],
      "properties": {
        "path": {
          "type": "string",
          "minLength": 1,
          "description": "Relative path within domain."
        },
        "type": {
          "type": "string",
          "enum": [
            "hash_mismatch",
            "missing",
            "extra"
          ],
          "description": "Type of mismatch detected."
        },
        "expected_hash": {
          "$ref": "#/definitions/sha256",
          "description": "Expected hash from pre_state. Required for hash_mismatch and missing."
        },
        "actual_hash": {
          "$ref": "#/definitions/sha256",
          "description": "Actual hash found. Required for hash_mismatch and extra."
        }
      }
    },
    "referenced_artifacts": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "ledger_hash",
        "jobspec_hash"
      ],
      "properties": {
        "ledger_hash": {
          "$ref": "#/definitions/sha256",
          "description": "SHA-256 hash of the ledger entry this proof validates."
        },
        "jobspec_hash": {
          "$ref": "#/definitions/sha256",
          "description": "SHA-256 hash of the jobspec that initiated the run."
        },
        "validator_id": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "validator_semver",
            "validator_build_id"
          ],
          "properties": {
            "validator_semver": {
              "type": "string",
              "minLength": 1
            },
            "validator_build_id": {
              "type": "string",
              "minLength": 1
            }
          },
          "description": "Identity of validator that generated this proof."
        }
      }
    }
  }
}
