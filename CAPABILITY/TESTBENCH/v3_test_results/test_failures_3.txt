============================= test session starts =============================
platform win32 -- Python 3.11.6, pytest-9.0.2, pluggy-1.6.0 -- C:\Users\rene_\AppData\Local\Programs\Python\Python311\python.exe
cachedir: .pytest_cache
rootdir: d:\CCC 2.0\AI\agent-governance-system
configfile: pytest.ini
plugins: anyio-4.12.0
collecting ... collected 6 items

CAPABILITY/TESTBENCH/test_ags_phase6_router_slot.py::test_ags_plan_router_happy_path FAILED [ 16%]
CAPABILITY/TESTBENCH/test_ags_phase6_router_slot.py::test_ags_plan_fails_on_stderr PASSED [ 33%]
CAPABILITY/TESTBENCH/test_ags_phase6_router_slot.py::test_ags_plan_caps_bytes PASSED [ 50%]
CAPABILITY/TESTBENCH/test_ags_phase6_router_slot.py::test_ags_route_rejects_invalid_plan_schema PASSED [ 66%]
CAPABILITY/TESTBENCH/test_ags_phase6_router_slot.py::test_ags_plan_jobspec_validation PASSED [ 83%]
CAPABILITY/TESTBENCH/test_ags_phase6_router_slot.py::test_ags_route_rejects_missing_step_command FAILED [100%]

================================== FAILURES ===================================
_______________________ test_ags_plan_router_happy_path _______________________

tmp_path = WindowsPath('C:/Users/rene_/AppData/Local/Temp/pytest-of-Reneshizzle/pytest-217/test_ags_plan_router_happy_pat0')

    def test_ags_plan_router_happy_path(tmp_path: Path) -> None:
        pipeline_id = "ags-router-happy"
        tmp_root = "ags_router_happy"
        plan_out = tmp_path / "plan.json"
    
        plan_obj = {
            "plan_version": "1.0",
            "pipeline_id": "ignored-by-override",
            "steps": [{"step_id": "s1", "command": [sys.executable, "-c", "pass"], "jobspec": _valid_jobspec(tmp_root=tmp_root)}],
        }
        router_code = "import json,sys;sys.stdout.write(json.dumps(%s))" % json.dumps(plan_obj)
        r1 = _run_ags(
            [
                "plan",
                "--router",
                sys.executable,
                "--router-arg=-c",
                f"--router-arg={router_code}",
                "--out",
                str(plan_out),
                "--pipeline-id",
                pipeline_id,
            ]
        )
>       assert r1.returncode == 0, r1.stdout + r1.stderr
E       AssertionError: ERROR: jobspec invalid: PATH_NOT_ALLOWED: Path CORTEX/_generated/_tmp/ags_router_happy_noop.txt in outputs.durable_paths not under allowed roots: ['LAW/CONTRACTS/_runs', 'NAVIGATION/CORTEX/_generated', 'MEMORY/LLM_PACKER/_packs', 'CAPABILITY/PRIMITIVES/_scratch']
E         
E       assert 2 == 0
E        +  where 2 = CompletedProcess(args=['C:\\Users\\rene_\\AppData\\Local\\Programs\\Python\\Python311\\python.exe', '-m', 'CAPABILITY.TOOLS.ags', 'plan', '--router', 'C:\\Users\\rene_\\AppData\\Local\\Programs\\Python\\Python311\\python.exe', '--router-arg=-c', '--router-arg=import json,sys;sys.stdout.write(json.dumps({"plan_version": "1.0", "pipeline_id": "ignored-by-override", "steps": [{"step_id": "s1", "command": ["C:\\\\Users\\\\rene_\\\\AppData\\\\Local\\\\Programs\\\\Python\\\\Python311\\\\python.exe", "-c", "pass"], "jobspec": {"job_id": "ags-router-step1", "phase": 6, "task_type": "pipeline_execution", "intent": "router produced step", "inputs": {}, "outputs": {"durable_paths": ["CORTEX/_generated/_tmp/ags_router_happy_noop.txt"], "validation_criteria": {}}, "catalytic_domains": ["LAW/CONTRACTS/_runs/_tmp/ags_router_happy/domain"], "determinism": "deterministic"}}]}))', '--out', 'C:\\Users\\rene_\\AppData\\Local\\Temp\\pytest-of-Reneshizzle\\pytest-217\\test_ags_plan_router_happy_pat0\\plan.json', '--pipeline-id', 'ags-router-happy'], returncode=2, stdout='', stderr="ERROR: jobspec invalid: PATH_NOT_ALLOWED: Path CORTEX/_generated/_tmp/ags_router_happy_noop.txt in outputs.durable_paths not under allowed roots: ['LAW/CONTRACTS/_runs', 'NAVIGATION/CORTEX/_generated', 'MEMORY/LLM_PACKER/_packs', 'CAPABILITY/PRIMITIVES/_scratch']\n").returncode

CAPABILITY\TESTBENCH\test_ags_phase6_router_slot.py:66: AssertionError
_________________ test_ags_route_rejects_missing_step_command _________________

tmp_path = WindowsPath('C:/Users/rene_/AppData/Local/Temp/pytest-of-Reneshizzle/pytest-217/test_ags_route_rejects_missing0')

    def test_ags_route_rejects_missing_step_command(tmp_path: Path) -> None:
        pipeline_id = "ags-router-missing-command"
        plan_path = tmp_path / "plan.json"
        plan_path.write_text(
            json.dumps({"steps": [{"step_id": "s1", "jobspec": _valid_jobspec(tmp_root="ags_router_missing_cmd")}]}),
            encoding="utf-8",
        )
        r = _run_ags(["route", "--plan", str(plan_path), "--pipeline-id", pipeline_id, "--runs-root", "LAW/CONTRACTS/_runs"])
        assert r.returncode != 0
>       assert "MISSING_STEP_COMMAND" in r.stderr
E       assert 'MISSING_STEP_COMMAND' in "ERROR: jobspec invalid: PATH_NOT_ALLOWED: Path CORTEX/_generated/_tmp/ags_router_missing_cmd_noop.txt in outputs.durable_paths not under allowed roots: ['LAW/CONTRACTS/_runs', 'NAVIGATION/CORTEX/_generated', 'MEMORY/LLM_PACKER/_packs', 'CAPABILITY/PRIMITIVES/_scratch']\n"
E        +  where "ERROR: jobspec invalid: PATH_NOT_ALLOWED: Path CORTEX/_generated/_tmp/ags_router_missing_cmd_noop.txt in outputs.durable_paths not under allowed roots: ['LAW/CONTRACTS/_runs', 'NAVIGATION/CORTEX/_generated', 'MEMORY/LLM_PACKER/_packs', 'CAPABILITY/PRIMITIVES/_scratch']\n" = CompletedProcess(args=['C:\\Users\\rene_\\AppData\\Local\\Programs\\Python\\Python311\\python.exe', '-m', 'CAPABILITY.TOOLS.ags', 'route', '--plan', 'C:\\Users\\rene_\\AppData\\Local\\Temp\\pytest-of-Reneshizzle\\pytest-217\\test_ags_route_rejects_missing0\\plan.json', '--pipeline-id', 'ags-router-missing-command', '--runs-root', 'LAW/CONTRACTS/_runs'], returncode=2, stdout='', stderr="ERROR: jobspec invalid: PATH_NOT_ALLOWED: Path CORTEX/_generated/_tmp/ags_router_missing_cmd_noop.txt in outputs.durable_paths not under allowed roots: ['LAW/CONTRACTS/_runs', 'NAVIGATION/CORTEX/_generated', 'MEMORY/LLM_PACKER/_packs', 'CAPABILITY/PRIMITIVES/_scratch']\n").stderr

CAPABILITY\TESTBENCH\test_ags_phase6_router_slot.py:190: AssertionError
=========================== short test summary info ===========================
FAILED CAPABILITY/TESTBENCH/test_ags_phase6_router_slot.py::test_ags_plan_router_happy_path - AssertionError: ERROR: jobspec invalid: PATH_NOT_ALLOWED: Path CORTEX/_generated/_tmp/ags_router_happy_noop.txt in outputs.durable_paths not under allowed roots: ['LAW/CONTRACTS/_runs', 'NAVIGATION/CORTEX/_generated', 'MEMORY/LLM_PACKER/_packs', 'CAPABILITY/PRIMITIVES/_scratch']
  
assert 2 == 0
 +  where 2 = CompletedProcess(args=['C:\\Users\\rene_\\AppData\\Local\\Programs\\Python\\Python311\\python.exe', '-m', 'CAPABILITY.TOOLS.ags', 'plan', '--router', 'C:\\Users\\rene_\\AppData\\Local\\Programs\\Python\\Python311\\python.exe', '--router-arg=-c', '--router-arg=import json,sys;sys.stdout.write(json.dumps({"plan_version": "1.0", "pipeline_id": "ignored-by-override", "steps": [{"step_id": "s1", "command": ["C:\\\\Users\\\\rene_\\\\AppData\\\\Local\\\\Programs\\\\Python\\\\Python311\\\\python.exe", "-c", "pass"], "jobspec": {"job_id": "ags-router-step1", "phase": 6, "task_type": "pipeline_execution", "intent": "router produced step", "inputs": {}, "outputs": {"durable_paths": ["CORTEX/_generated/_tmp/ags_router_happy_noop.txt"], "validation_criteria": {}}, "catalytic_domains": ["LAW/CONTRACTS/_runs/_tmp/ags_router_happy/domain"], "determinism": "deterministic"}}]}))', '--out', 'C:\\Users\\rene_\\AppData\\Local\\Temp\\pytest-of-Reneshizzle\\pytest-217\\test_ags_plan_router_happy_pat0\\plan.json', '--pipeline-id', 'ags-router-happy'], returncode=2, stdout='', stderr="ERROR: jobspec invalid: PATH_NOT_ALLOWED: Path CORTEX/_generated/_tmp/ags_router_happy_noop.txt in outputs.durable_paths not under allowed roots: ['LAW/CONTRACTS/_runs', 'NAVIGATION/CORTEX/_generated', 'MEMORY/LLM_PACKER/_packs', 'CAPABILITY/PRIMITIVES/_scratch']\n").returncode
FAILED CAPABILITY/TESTBENCH/test_ags_phase6_router_slot.py::test_ags_route_rejects_missing_step_command - assert 'MISSING_STEP_COMMAND' in "ERROR: jobspec invalid: PATH_NOT_ALLOWED: Path CORTEX/_generated/_tmp/ags_router_missing_cmd_noop.txt in outputs.durable_paths not under allowed roots: ['LAW/CONTRACTS/_runs', 'NAVIGATION/CORTEX/_generated', 'MEMORY/LLM_PACKER/_packs', 'CAPABILITY/PRIMITIVES/_scratch']\n"
 +  where "ERROR: jobspec invalid: PATH_NOT_ALLOWED: Path CORTEX/_generated/_tmp/ags_router_missing_cmd_noop.txt in outputs.durable_paths not under allowed roots: ['LAW/CONTRACTS/_runs', 'NAVIGATION/CORTEX/_generated', 'MEMORY/LLM_PACKER/_packs', 'CAPABILITY/PRIMITIVES/_scratch']\n" = CompletedProcess(args=['C:\\Users\\rene_\\AppData\\Local\\Programs\\Python\\Python311\\python.exe', '-m', 'CAPABILITY.TOOLS.ags', 'route', '--plan', 'C:\\Users\\rene_\\AppData\\Local\\Temp\\pytest-of-Reneshizzle\\pytest-217\\test_ags_route_rejects_missing0\\plan.json', '--pipeline-id', 'ags-router-missing-command', '--runs-root', 'LAW/CONTRACTS/_runs'], returncode=2, stdout='', stderr="ERROR: jobspec invalid: PATH_NOT_ALLOWED: Path CORTEX/_generated/_tmp/ags_router_missing_cmd_noop.txt in outputs.durable_paths not under allowed roots: ['LAW/CONTRACTS/_runs', 'NAVIGATION/CORTEX/_generated', 'MEMORY/LLM_PACKER/_packs', 'CAPABILITY/PRIMITIVES/_scratch']\n").stderr
========================= 2 failed, 4 passed in 1.66s =========================
