============================= test session starts =============================
platform win32 -- Python 3.11.6, pytest-9.0.2, pluggy-1.6.0 -- C:\Users\rene_\AppData\Local\Programs\Python\Python311\python.exe
cachedir: .pytest_cache
rootdir: d:\CCC 2.0\AI\agent-governance-system
configfile: pytest.ini
plugins: anyio-4.12.0
collecting ... collected 26 items

CAPABILITY/TESTBENCH/test_ags_phase6_capability_versioning_semantics.py::test_capability_versioning_in_place_upgrade_rejected PASSED [  3%]
CAPABILITY/TESTBENCH/test_ags_phase6_mcp_adapter_e2e.py::test_happy_echo PASSED [  7%]
CAPABILITY/TESTBENCH/test_ags_phase6_mcp_adapter_e2e.py::test_fail_stderr PASSED [ 11%]
CAPABILITY/TESTBENCH/test_ags_phase6_mcp_adapter_e2e.py::test_fail_timeout PASSED [ 15%]
CAPABILITY/TESTBENCH/test_ags_phase6_mcp_adapter_e2e.py::test_fail_bloat PASSED [ 19%]
CAPABILITY/TESTBENCH/test_ags_phase6_mcp_adapter_e2e.py::test_fail_malformed_output PASSED [ 23%]
CAPABILITY/TESTBENCH/test_ags_phase6_mcp_adapter_e2e.py::test_fail_crash PASSED [ 26%]
CAPABILITY/TESTBENCH/test_ags_phase6_registry_immutability.py::test_registry_duplicate_capability_hash_rejects PASSED [ 30%]
CAPABILITY/TESTBENCH/test_ags_phase6_registry_immutability.py::test_registry_noncanonical_json_rejects PASSED [ 34%]
CAPABILITY/TESTBENCH/test_ags_phase6_registry_immutability.py::test_registry_tamper_detected_fail_closed PASSED [ 38%]
CAPABILITY/TESTBENCH/test_ags_phase6_router_slot.py::test_ags_plan_router_happy_path FAILED [ 42%]
CAPABILITY/TESTBENCH/test_ags_phase6_router_slot.py::test_ags_plan_fails_on_stderr PASSED [ 46%]
CAPABILITY/TESTBENCH/test_ags_phase6_router_slot.py::test_ags_plan_caps_bytes PASSED [ 50%]
CAPABILITY/TESTBENCH/test_ags_phase6_router_slot.py::test_ags_route_rejects_invalid_plan_schema PASSED [ 53%]
CAPABILITY/TESTBENCH/test_ags_phase6_router_slot.py::test_ags_plan_jobspec_validation PASSED [ 57%]
CAPABILITY/TESTBENCH/test_ags_phase6_router_slot.py::test_ags_route_rejects_missing_step_command FAILED [ 61%]
CAPABILITY/TESTBENCH/test_ags_phase8_model_binding.py::test_ags_plan_emits_router_receipts FAILED [ 65%]
CAPABILITY/TESTBENCH/test_ags_phase8_model_binding.py::test_ags_plan_over_output_fails_closed PASSED [ 69%]
CAPABILITY/TESTBENCH/test_cortex_integration.py::test_system1_db PASSED  [ 73%]
CAPABILITY/TESTBENCH/test_cortex_integration.py::test_cortex_indexer PASSED [ 76%]
CAPABILITY/TESTBENCH/test_cortex_integration.py::test_search_functionality PASSED [ 80%]
CAPABILITY/TESTBENCH/test_governance_coverage.py::test_roadmap_deliverables_exist PASSED [ 84%]
CAPABILITY/TESTBENCH/test_governance_coverage.py::test_canon_mentions_key_concepts PASSED [ 88%]
CAPABILITY/TESTBENCH/test_governance_coverage.py::test_router_receipt_artifacts_in_schema PASSED [ 92%]
CAPABILITY/TESTBENCH/test_governance_coverage.py::test_policy_snapshot_logic_exists PASSED [ 96%]
CAPABILITY/TESTBENCH/test_governance_coverage.py::test_swarm_schema_validity PASSED [100%]

================================== FAILURES ===================================
_______________________ test_ags_plan_router_happy_path _______________________

tmp_path = WindowsPath('C:/Users/rene_/AppData/Local/Temp/pytest-of-Reneshizzle/pytest-206/test_ags_plan_router_happy_pat0')

    def test_ags_plan_router_happy_path(tmp_path: Path) -> None:
        pipeline_id = "ags-router-happy"
        tmp_root = "ags_router_happy"
        plan_out = tmp_path / "plan.json"
    
        plan_obj = {
            "plan_version": "1.0",
            "pipeline_id": "ignored-by-override",
            "steps": [{"step_id": "s1", "command": [sys.executable, "-c", "pass"], "jobspec": _valid_jobspec(tmp_root=tmp_root)}],
        }
        router_code = "import json,sys;sys.stdout.write(json.dumps(%s))" % json.dumps(plan_obj)
        r1 = _run_ags(
            [
                "plan",
                "--router",
                sys.executable,
                "--router-arg=-c",
                f"--router-arg={router_code}",
                "--out",
                str(plan_out),
                "--pipeline-id",
                pipeline_id,
            ]
        )
>       assert r1.returncode == 0, r1.stdout + r1.stderr
E       AssertionError: ERROR: jobspec invalid: PATH_NOT_ALLOWED: Path CONTRACTS/_runs/_tmp/ags_router_happy/domain in catalytic_domains not under allowed roots: ['LAW/CONTRACTS/_runs', 'NAVIGATION/CORTEX/_generated', 'MEMORY/LLM_PACKER/_packs', 'CAPABILITY/PRIMITIVES/_scratch']
E         
E       assert 2 == 0
E        +  where 2 = CompletedProcess(args=['C:\\Users\\rene_\\AppData\\Local\\Programs\\Python\\Python311\\python.exe', '-m', 'CAPABILITY.TOOLS.ags', 'plan', '--router', 'C:\\Users\\rene_\\AppData\\Local\\Programs\\Python\\Python311\\python.exe', '--router-arg=-c', '--router-arg=import json,sys;sys.stdout.write(json.dumps({"plan_version": "1.0", "pipeline_id": "ignored-by-override", "steps": [{"step_id": "s1", "command": ["C:\\\\Users\\\\rene_\\\\AppData\\\\Local\\\\Programs\\\\Python\\\\Python311\\\\python.exe", "-c", "pass"], "jobspec": {"job_id": "ags-router-step1", "phase": 6, "task_type": "pipeline_execution", "intent": "router produced step", "inputs": {}, "outputs": {"durable_paths": ["CORTEX/_generated/_tmp/ags_router_happy_noop.txt"], "validation_criteria": {}}, "catalytic_domains": ["CONTRACTS/_runs/_tmp/ags_router_happy/domain"], "determinism": "deterministic"}}]}))', '--out', 'C:\\Users\\rene_\\AppData\\Local\\Temp\\pytest-of-Reneshizzle\\pytest-206\\test_ags_plan_router_happy_pat0\\plan.json', '--pipeline-id', 'ags-router-happy'], returncode=2, stdout='', stderr="ERROR: jobspec invalid: PATH_NOT_ALLOWED: Path CONTRACTS/_runs/_tmp/ags_router_happy/domain in catalytic_domains not under allowed roots: ['LAW/CONTRACTS/_runs', 'NAVIGATION/CORTEX/_generated', 'MEMORY/LLM_PACKER/_packs', 'CAPABILITY/PRIMITIVES/_scratch']\n").returncode

CAPABILITY\TESTBENCH\test_ags_phase6_router_slot.py:66: AssertionError
_________________ test_ags_route_rejects_missing_step_command _________________

tmp_path = WindowsPath('C:/Users/rene_/AppData/Local/Temp/pytest-of-Reneshizzle/pytest-206/test_ags_route_rejects_missing0')

    def test_ags_route_rejects_missing_step_command(tmp_path: Path) -> None:
        pipeline_id = "ags-router-missing-command"
        plan_path = tmp_path / "plan.json"
        plan_path.write_text(
            json.dumps({"steps": [{"step_id": "s1", "jobspec": _valid_jobspec(tmp_root="ags_router_missing_cmd")}]}),
            encoding="utf-8",
        )
        r = _run_ags(["route", "--plan", str(plan_path), "--pipeline-id", pipeline_id, "--runs-root", "_runs"])
        assert r.returncode != 0
>       assert "MISSING_STEP_COMMAND" in r.stderr
E       AssertionError: assert 'MISSING_STEP_COMMAND' in 'ERROR: UNSUPPORTED_RUNS_ROOT (only LAW/CONTRACTS/_runs is supported)\n'
E        +  where 'ERROR: UNSUPPORTED_RUNS_ROOT (only LAW/CONTRACTS/_runs is supported)\n' = CompletedProcess(args=['C:\\Users\\rene_\\AppData\\Local\\Programs\\Python\\Python311\\python.exe', '-m', 'CAPABILITY.TOOLS.ags', 'route', '--plan', 'C:\\Users\\rene_\\AppData\\Local\\Temp\\pytest-of-Reneshizzle\\pytest-206\\test_ags_route_rejects_missing0\\plan.json', '--pipeline-id', 'ags-router-missing-command', '--runs-root', '_runs'], returncode=2, stdout='', stderr='ERROR: UNSUPPORTED_RUNS_ROOT (only LAW/CONTRACTS/_runs is supported)\n').stderr

CAPABILITY\TESTBENCH\test_ags_phase6_router_slot.py:190: AssertionError
_____________________ test_ags_plan_emits_router_receipts _____________________

tmp_path = WindowsPath('C:/Users/rene_/AppData/Local/Temp/pytest-of-Reneshizzle/pytest-206/test_ags_plan_emits_router_rec0')

    def test_ags_plan_emits_router_receipts(tmp_path: Path):
        pipeline_id = "test-phase8-receipts"
        plan_out = tmp_path / "plan.json"
        pdir = REPO_ROOT / "LAW" / "CONTRACTS" / "_runs" / "_pipelines" / pipeline_id
    
        # Dummy plan output from a router
        plan_obj = {
            "plan_version": "1.0",
            "steps": [
                {
                    "step_id": "s1",
                    "command": ["echo", "hello"],
                    "jobspec": {
                        "job_id": "job1",
                        "intent": "test",
                        "phase": 8,
                        "task_type": "test_execution",
                        "inputs": {},
                        "outputs": {"durable_paths": [], "validation_criteria": {}},
                        "catalytic_domains": [],
                        "determinism": "deterministic"
                    }
                }
            ]
        }
        router_code = "import json,sys;sys.stdout.write(json.dumps(%s))" % json.dumps(plan_obj)
    
        try:
            _rm(pdir)
    
            r = _run_ags([
                "plan",
                "--router", sys.executable,
                "--router-arg=-c",
                f"--router-arg={router_code}",
                "--out", str(plan_out),
                "--pipeline-id", pipeline_id
            ])
            assert r.returncode == 0, r.stdout + r.stderr
    
            # 1. Check plan.json has embedded router metadata
            plan = json.loads(plan_out.read_text(encoding="utf-8"))
            assert "router" in plan
            assert plan["router"]["router_executable"] == sys.executable
            assert plan["router"]["transcript_hash"] is not None
    
            # 2. Check pipeline directory artifacts
            router_dir = pdir / "ROUTER"
>           assert (router_dir.exists() and (pdir / "ROUTER_OUTPUT.json").exists())
E           AssertionError: assert (False)
E            +  where False = exists()
E            +    where exists = WindowsPath('D:/CCC 2.0/AI/agent-governance-system/LAW/CONTRACTS/_runs/_pipelines/test-phase8-receipts/ROUTER').exists

CAPABILITY\TESTBENCH\test_ags_phase8_model_binding.py:75: AssertionError
=========================== short test summary info ===========================
FAILED CAPABILITY/TESTBENCH/test_ags_phase6_router_slot.py::test_ags_plan_router_happy_path - AssertionError: ERROR: jobspec invalid: PATH_NOT_ALLOWED: Path CONTRACTS/_runs/_tmp/ags_router_happy/domain in catalytic_domains not under allowed roots: ['LAW/CONTRACTS/_runs', 'NAVIGATION/CORTEX/_generated', 'MEMORY/LLM_PACKER/_packs', 'CAPABILITY/PRIMITIVES/_scratch']
  
assert 2 == 0
 +  where 2 = CompletedProcess(args=['C:\\Users\\rene_\\AppData\\Local\\Programs\\Python\\Python311\\python.exe', '-m', 'CAPABILITY.TOOLS.ags', 'plan', '--router', 'C:\\Users\\rene_\\AppData\\Local\\Programs\\Python\\Python311\\python.exe', '--router-arg=-c', '--router-arg=import json,sys;sys.stdout.write(json.dumps({"plan_version": "1.0", "pipeline_id": "ignored-by-override", "steps": [{"step_id": "s1", "command": ["C:\\\\Users\\\\rene_\\\\AppData\\\\Local\\\\Programs\\\\Python\\\\Python311\\\\python.exe", "-c", "pass"], "jobspec": {"job_id": "ags-router-step1", "phase": 6, "task_type": "pipeline_execution", "intent": "router produced step", "inputs": {}, "outputs": {"durable_paths": ["CORTEX/_generated/_tmp/ags_router_happy_noop.txt"], "validation_criteria": {}}, "catalytic_domains": ["CONTRACTS/_runs/_tmp/ags_router_happy/domain"], "determinism": "deterministic"}}]}))', '--out', 'C:\\Users\\rene_\\AppData\\Local\\Temp\\pytest-of-Reneshizzle\\pytest-206\\test_ags_plan_router_happy_pat0\\plan.json', '--pipeline-id', 'ags-router-happy'], returncode=2, stdout='', stderr="ERROR: jobspec invalid: PATH_NOT_ALLOWED: Path CONTRACTS/_runs/_tmp/ags_router_happy/domain in catalytic_domains not under allowed roots: ['LAW/CONTRACTS/_runs', 'NAVIGATION/CORTEX/_generated', 'MEMORY/LLM_PACKER/_packs', 'CAPABILITY/PRIMITIVES/_scratch']\n").returncode
FAILED CAPABILITY/TESTBENCH/test_ags_phase6_router_slot.py::test_ags_route_rejects_missing_step_command - AssertionError: assert 'MISSING_STEP_COMMAND' in 'ERROR: UNSUPPORTED_RUNS_ROOT (only LAW/CONTRACTS/_runs is supported)\n'
 +  where 'ERROR: UNSUPPORTED_RUNS_ROOT (only LAW/CONTRACTS/_runs is supported)\n' = CompletedProcess(args=['C:\\Users\\rene_\\AppData\\Local\\Programs\\Python\\Python311\\python.exe', '-m', 'CAPABILITY.TOOLS.ags', 'route', '--plan', 'C:\\Users\\rene_\\AppData\\Local\\Temp\\pytest-of-Reneshizzle\\pytest-206\\test_ags_route_rejects_missing0\\plan.json', '--pipeline-id', 'ags-router-missing-command', '--runs-root', '_runs'], returncode=2, stdout='', stderr='ERROR: UNSUPPORTED_RUNS_ROOT (only LAW/CONTRACTS/_runs is supported)\n').stderr
FAILED CAPABILITY/TESTBENCH/test_ags_phase8_model_binding.py::test_ags_plan_emits_router_receipts - AssertionError: assert (False)
 +  where False = exists()
 +    where exists = WindowsPath('D:/CCC 2.0/AI/agent-governance-system/LAW/CONTRACTS/_runs/_pipelines/test-phase8-receipts/ROUTER').exists
======================== 3 failed, 23 passed in 5.22s =========================
