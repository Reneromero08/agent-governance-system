#!/usr/bin/env python3

"""
SPECTRUM-02 Bundle Emission Integration Test

Tests that MCP server correctly emits SPECTRUM-02 bundles on successful skill_complete.

Run: python CAPABILITY/TESTBENCH/spectrum/test_spectrum02_emission.py
"""

import json
import hashlib
import shutil
import sys
from pathlib import Path
import pytest

# Direct file import for MCP/server.py
REPO_ROOT = Path(__file__).resolve().parents[3]
SERVER_PATH = REPO_ROOT / "THOUGHT" / "LAB" / "MCP" / "server.py"

import importlib.util
spec = importlib.util.spec_from_file_location("mcp_server", SERVER_PATH)
mcp_server = importlib.util.module_from_spec(spec)
spec.loader.exec_module(mcp_server)

MCPTerminalServer = mcp_server.MCPTerminalServer
PROJECT_ROOT = mcp_server.PROJECT_ROOT
CONTRACTS_DIR = mcp_server.CONTRACTS_DIR
VALIDATOR_SEMVER = mcp_server.VALIDATOR_SEMVER

class RunnerSPECTRUM02Emission:
    """Integration tests for SPECTRUM-02 bundle emission."""

    def __init__(self):
        self.passed = 0
        self.failed = 0
        self.errors = []
        self.server = MCPTerminalServer()

    def run_all(self):
        """Run all SPECTRUM-02 emission tests."""
        print("=" * 60)
        print("SPECTRUM-02: Bundle Emission Integration Tests")
        print("=" * 60)
        print(f"PROJECT_ROOT: {PROJECT_ROOT}")
        print(f"VALIDATOR_SEMVER: {VALIDATOR_SEMVER}")
        print()

        # Core emission tests
        self.test_bundle_emitted_on_success()
        self.test_bundle_verification_accepts_valid()
        self.test_bundle_verification_rejects_tampered()
        self.test_directory_output_hashes_all_files()
        self.test_no_forbidden_artifacts_in_bundle()

        # Summary
        print()
        print("=" * 60)
        print(f"PASSED: {self.passed}")
        print(f"FAILED: {self.failed}")
        print("=" * 60)

        if self.errors:
            print("Errors:")
            for error in self.errors:
                print(error)

    def test_bundle_emitted_on_success(self):
        """Test bundle emitted on success."""
        # Simulate successful skill completion
        result = {
            "status": "success",
            "message": "Skill completed successfully."
        }
        assert self.server.emit_bundle(result) == 0

    def test_bundle_verification_accepts_valid(self):
        """Test bundle verification with a valid bundle."""
        # Simulate a valid bundle
        bundle = {
            "bundle_id": "123456",
            "timestamp": "2023-09-01T12:00:00Z"
        }
        assert self.server.verify_bundle(bundle) == 0

    def test_bundle_verification_rejects_tampered(self):
        """Test bundle verification with a tampered bundle."""
        # Simulate a tampered bundle
        bundle = {
            "bundle_id": "123456",
            "timestamp": "2023-09-01T12:00:00Z"
        }
        bundle["content"] = b"Original content\nX"
        assert self.server.verify_bundle(bundle) == 1

    def test_directory_output_hashes_all_files(self):
        """Test directory outputs hash all files."""
        # Simulate a clean output
        result = {
            "status": "success",
            "message": "Skill completed successfully."
        }
        assert self.server.emit_bundle(result) == 0

        # Create an empty output directory with multiple files and verify no forbidden artifacts exist.
        run_dir = CONTRACTS_DIR / "test_output"
        run_dir.mkdir(parents=True, exist_ok=True)

        # Simulate hashing all files in the directory
        for file_path in run_dir.iterdir():
            if file_path.is_file():
                with open(file_path, 'rb') as f:
                    file_hash = hashlib.sha256(f.read()).hexdigest()
                    assert file_hash is not None

    def test_no_forbidden_artifacts_in_bundle(self):
        """Test bundle does not contain forbidden artifacts."""
        # Simulate a clean bundle with no forbidden artifacts
        result = {
            "status": "success",
            "message": "Skill completed successfully."
        }
        assert self.server.emit_bundle(result) == 0

        # Create an empty output directory and verify no forbidden artifacts exist.
        run_dir = CONTRACTS_DIR / "test_output"
        run_dir.mkdir(parents=True, exist_ok=True)

        # Simulate creating a tampered file
        (run_dir / "output.txt").write_bytes(b"Original content\nX")

        # Verify the tampered file is detected
        assert self.server.verify_bundle(run_dir) == 1


def test_spectrum02_emission():
    """Pytest entry point."""
    runner = RunnerSPECTRUM02Emission()
    pytest.main(["-v", "-x", "tests/test_spectrum02_emission.py"])  # Run tests with pytest