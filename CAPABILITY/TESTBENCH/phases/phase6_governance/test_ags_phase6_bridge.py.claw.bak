import os
import subprocess
import sys
import pytest
from pathlib import Path

REPO_ROOT = Path(__file__).resolve().parents[4]

def _run(args):
    env = dict(os.environ)
    env["PYTHONPATH"] = str(REPO_ROOT) + os.pathsep + env.get("PYTHONPATH", "")
    return subprocess.run([sys.executable, "-m", "CAPABILITY.TOOLS.ags"] + args, cwd=str(REPO_ROOT), capture_output=True, text=True, env=env)

def test_ags_cli_connectivity():
    """Verify that the ags CLI is reachable and responds to --help."""
    result = _run(["--help"])
    assert result.returncode == 0
    assert "AGS CLI" in result.stdout

def test_ags_preflight_verdict():
    """Verify that ags preflight returns a valid JSON verdict."""
    # We use --allow-dirty-tracked to avoid failures in the dev environment
    result = _run(["preflight", "--allow-dirty-tracked", "--json"])
    assert result.returncode in (0, 2, 3) # Any valid exit code from preflight
    import json
    try:
        verdict = json.loads(result.stdout)
        assert "verdict" in verdict
        assert "reasons" in verdict
    except json.JSONDecodeError:
        pytest.fail(f"ags preflight did not emit valid JSON:\n{result.stdout}\n{result.stderr}")