import json
import os
import shutil
import subprocess
import sys
from pathlib import Path

REPO_ROOT = Path(__file__).resolve().parents[3]

def _run(cmd, env=None):
    return subprocess.run(
        cmd, cwd=str(REPO_ROOT), capture_output=True, text=True, check=True, env=env or os.environ
    )

def _rm(path: Path) -> None:
    if path.is_dir():
        shutil.rmtree(path, ignore_errors=True)
    else:
        try:
            path.unlink()
        except FileNotFoundError:
            pass

def test_router_receipts_created(tmp_path):
    """Router execution must create receipt artifacts."""
    # Create a simple router that outputs a valid plan
    router_script = tmp_path / "router.py"
    router_script.write_text(
        """
import json
import sys

plan = {
    "plan_version": "1.0",
    "steps": [
        {
            "step_id": "test-step",
            "command": ["echo", "hello"],
            "jobspec": {
                "job_id": "test-job",
                "phase": 8,
                "task_type": "test_execution",
                "intent": "Test router receipts",
                "inputs": {},
                "outputs": {
                    "durable_paths": [],
                    "validation_criteria": {}
                },
                "catalytic_domains": [],
                "determinism": "deterministic"
            }
        }
    ]
}
sys.stdout.write(json.dumps(plan))
""",
        encoding="utf-8",
    )

    plan_output = tmp_path / "plan.json"
    receipt_dir = tmp_path / ".router_receipts"

    try:
        _rm(receipt_dir)

        cmd = [
            sys.executable,
            "-m",
            "CAPABILITY/TESTBENCH/phases/phase8_router/CAPABILITY/TOOLS.ags",
            "plan",
            "--router",
            sys.executable,
            "--router-arg",
            str(router_script),
            "--out",
            str(plan_output),
        ]
        _run(cmd)

        assert plan_output.exists(), "Plan output file should exist"
    except subprocess.CalledProcessError as e:
        print(f"Router execution failed: {e}")
        raise

def test_malformed_plan_fails_schema_validation(tmp_path):
    """Router producing malformed JSON must fail schema validation."""
    router_script = tmp_path / "router_malformed.py"
    router_script.write_text(
        """
import sys

# Missing required fields
sys.stderr.write("ERROR: something went wrong\\n")
plan = {"plan_version": "1.0", "steps": []}
sys.stdout.write(json.dumps(plan))
""",
        encoding="utf-8",
    )

    plan_output = tmp_path / "plan.json"

    cmd = [
        sys.executable,
        "-m",
        "CAPABILITY/TESTBENCH/phases/phase8_router/CAPABILITY/TOOLS.ags",
        "plan",
        "--router",
        sys.executable,
        "--router-arg",
        str(router_script),
        "--out",
        str(plan_output),
    ]
    try:
        _run(cmd)
    except subprocess.CalledProcessError as e:
        assert "PLAN_SCHEMA_ERROR" in (e.stderr + e.stdout), "Expected PLAN_SCHEMA_ERROR"
    else:
        raise AssertionError("Router with malformed plan should fail")

def test_router_stderr_fails_closed(tmp_path):
    """Router producing stderr must fail closed."""
    router_script = tmp_path / "router_stderr.py"
    router_script.write_text(
        """
import sys
import json

sys.stderr.write("ERROR: something went wrong\\n")
plan = {"plan_version": "1.0", "steps": []}
sys.stdout.write(json.dumps(plan))
""",
        encoding="utf-8",
    )

    plan_output = tmp_path / "plan.json"

    cmd = [
        sys.executable,
        "-m",
        "CAPABILITY/TESTBENCH/phases/phase8_router/CAPABILITY/TOOLS.ags",
        "plan",
        "--router",
        sys.executable,
        "--router-arg",
        str(router_script),
        "--out",
        str(plan_output),
    ]
    try:
        _run(cmd)
    except subprocess.CalledProcessError as e:
        assert "ROUTER_STDERR_NOT_EMPTY" in (e.stderr + e.stdout), "Expected ROUTER_STDERR_NOT_EMPTY"
    else:
        raise AssertionError("Router with stderr should fail")

def test_router_escalation_fails_closed(tmp_path):
    """Router attempting capability escalation must fail closed."""
    # Create a router that tries to use a revoked capability
    router_script = tmp_path / "router_escalate.py"
    router_script.write_text(
        """
import json

# Try to use a capability that's revoked
plan = {
    "plan_version": "1.0",
    "steps": [{
        "step_id": "escalate",
        "capability_hash": "4f81ae57f3d1c61488c71a9042b041776dd463e6334568333321d15b6b7d78fc"
    }]
}
sys.stdout.write(json.dumps(plan))
""",
        encoding="utf-8",
    )

    # Create a revoked capability file
    revokes_file = tmp_path / "REVOKES.json"
    revokes_file.write_bytes(
        json.dumps(
            {
                "revokes_version": "1.0.0",
                "revoked_capabilities": [
                    "4f81ae57f3d1c61488c71a9042b041776dd463e6334568333321d15b6b7d78fc"
                ],
            },
            sort_keys=True,
            separators=(",", ":"),
        ).encode("utf-8")
    )

    plan_output = tmp_path / "plan.json"

    env = dict(os.environ)
    env["CATALYTIC_CAPABILITIES_PATH"] = str(
        REPO_ROOT / "LAW/CANON/CAPABILITIES.json"
    )
    env["CATALYTIC_PINS_PATH"] = str(
        REPO_ROOT / "LAW/CANON/CAPABILITY_PINS.json"
    )
    env["CATALYTIC_REVOKES_PATH"] = str(revokes_file)

    cmd = [
        sys.executable,
        "-m",
        "CAPABILITY/TESTBENCH/phases/phase8_router/CAPABILITY/TOOLS.ags",
        "plan",
        "--router",
        sys.executable,
        "--router-arg",
        str(router_script),
        "--out",
        str(plan_output),
    ]
    try:
        _run(cmd, env)
    except subprocess.CalledProcessError as e:
        assert "REVOKED_CAPABILITY" in (e.stderr + e.stdout), "Expected REVOKED_CAPABILITY"
    else:
        raise AssertionError("Router with revoked capability should fail")