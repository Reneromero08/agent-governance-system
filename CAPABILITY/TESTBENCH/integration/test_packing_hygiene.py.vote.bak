from __future__ import annotations
from pathlib import Path
import sys
import pytest

REPO_ROOT = Path(__file__).resolve().parents[3]
if str(REPO_ROOT) not in sys.path:
    sys.path.insert(0, str(REPO_ROOT))

from MEMORY.LLM_PACKER.Engine.packer.core import enforce_included_repo_limits, PackLimits

def test_packing_hygiene() -> None:
    # PackLimits requires allow_duplicate_hashes
    limits = {
        "max_total_bytes": 100,
        "max_entry_bytes": 50,
        "max_entries": 10,
        "allow_duplicate_hashes": True
    }
    
    # 1. Empty list should return stats
    res = enforce_included_repo_limits([], PackLimits(**limits))
    assert res["repo_bytes"] == 0
    assert res["repo_files"] == 0
    
    # 2. Exceed total bytes
    too_big = [{"path": "a.txt", "sha256": "f" * 64, "size_bytes": 101}]
    with pytest.raises(ValueError, match="PACK_LIMIT_EXCEEDED:max_total_bytes"):
        enforce_included_repo_limits(too_big, PackLimits(**limits))
    
    # 3. Exceed entry bytes
    too_big_entry = [{"path": "a.txt", "sha256": "f" * 64, "size_bytes": 51}]
    with pytest.raises(ValueError, match="PACK_LIMIT_EXCEEDED:max_entry_bytes"):
        enforce_included_repo_limits(too_big_entry, PackLimits(**limits))