{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Catalytic Chat Plan Step",
  "type": "object",
  "additionalProperties": false,
  "required": ["step_id", "ordinal", "op"],
  "properties": {
    "step_id": {
      "type": "string",
      "description": "Unique step identifier (deterministic SHA256)"
    },
    "ordinal": {
      "type": "integer",
      "minimum": 1,
      "description": "Step order within the plan"
    },
    "op": {
      "type": "string",
      "enum": ["READ_SECTION", "READ_SYMBOL", "WRITE_FILE", "PATCH_FILE", "RUN_TEST", "NOTE"],
      "description": "Type of operation to perform"
    },
    "refs": {
      "type": "object",
      "additionalProperties": true,
      "description": "References to external resources (depends on op type)",
      "properties": {
        "section_id": {
          "type": "string",
          "description": "Section ID to read (for READ_SECTION)"
        },
        "symbol_id": {
          "type": "string",
          "pattern": "^@[A-Z_]+/",
          "description": "@Symbol to resolve (for READ_SYMBOL)"
        },
        "file_path": {
          "type": "string",
          "description": "File path to write/patch (for WRITE_FILE, PATCH_FILE)"
        },
        "file_hash": {
          "type": "string",
          "description": "SHA256 hash of file content (for patch verification)"
        },
        "content": {
          "type": "string",
          "description": "Content to write (for WRITE_FILE)"
        },
        "patch_start_line": {
          "type": "integer",
          "minimum": 1,
          "description": "Line number to start patching"
        },
        "patch_end_line": {
          "type": "integer",
          "minimum": 1,
          "description": "Line number to end patching"
        },
        "test_name": {
          "type": "string",
          "description": "Test name to run (for RUN_TEST)"
        },
        "message": {
          "type": "string",
          "description": "Note message (for NOTE)"
        }
      }
    },
    "constraints": {
      "type": "object",
      "additionalProperties": true,
      "description": "Constraints on this step",
      "properties": {
        "timeout_seconds": {
          "type": "integer",
          "minimum": 1,
          "description": "Maximum seconds for this step"
        },
        "required_outputs": {
          "type": "array",
          "description": "Required outputs for this step",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "expected_outputs": {
      "type": "object",
      "additionalProperties": true,
      "description": "Expected outputs after this step",
      "properties": {
        "sections_read": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "symbols_resolved": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "files_modified": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "test_passed": {
          "type": "boolean"
        }
      }
    }
  }
}
