<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEO3000 // OPERATOR DECK</title>
    <script type="text/javascript" src="https://unpkg.com/vis-network/dist/vis-network.min.js"></script>
    <style>
        :root {
            --bg: #000000;
            --surface: rgba(0, 20, 0, 0.85);
            --accent-cyan: #00ff41;
            --accent-pink: #008f11;
            --text: #00ff41;
            --border: #008f11;
            --glow: 0 0 10px rgba(0, 255, 65, 0.5);
        }

        @import url('https://unpkg.com/vis-network/dist/vis-network.min.css');

        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background: #000000;
            color: var(--text);
            font-family: 'Lucida Console', 'Courier New', monospace;
            overflow: hidden;
        }

        /* Full-screen Cortex Constellation Background */
        #cortex-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1;
            background: #000000;
            cursor: grab;
        }

        #cortex-background:active {
            cursor: grabbing;
        }

        #cortex-background canvas {
            width: 100% !important;
            height: 100% !important;
        }

        /* Scanline Overlay */
        body::after {
            content: " ";
            display: block;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.15) 50%);
            z-index: 1000;
            background-size: 100% 4px;
            pointer-events: none;
            opacity: 0.2;
        }

        #desktop {
            position: relative;
            width: 100vw;
            height: 100vh;
            padding: 20px;
            box-sizing: border-box;
            z-index: 10;
            pointer-events: none;
        }

        /* Window Styling */
        .window {
            position: absolute;
            background: var(--surface);
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5), inset 0 0 10px rgba(255, 255, 255, 0.02);
            display: flex;
            flex-direction: column;
            min-width: 300px;
            min-height: 200px;
            z-index: 100;
            pointer-events: auto;
        }

        .window-header {
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid var(--border);
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }

        .window-title {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--accent-cyan);
            text-shadow: var(--glow);
        }

        .window-content {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.6;
        }

        /* Specific Windows */
        #cortex-search-panel {
            top: 50px;
            left: 50px;
            width: 350px;
            height: auto;
            min-height: 60px;
        }

        #remote-view {
            top: 150px;
            left: 50px;
            width: 500px;
            height: 350px;
        }

        #terminal {
            bottom: 60px;
            left: 50px;
            width: 500px;
            height: 250px;
        }

        #swarm-monitor {
            top: 50px;
            right: 50px;
            width: 500px;
            height: 400px;
        }

        /* UI Elements */
        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 40px;
            background: rgba(0, 0, 0, 0.9);
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 20px;
            box-sizing: border-box;
            font-size: 12px;
            z-index: 1001;
        }

        .status-item {
            margin-right: 20px;
            display: flex;
            align-items: center;
            color: rgba(255, 255, 255, 0.5);
        }

        .status-item b {
            color: var(--accent-cyan);
            margin-left: 5px;
        }

        .led {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-cyan);
            margin-right: 8px;
            box-shadow: 0 0 5px var(--accent-cyan);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }

        /* Search Bar */
        input[type="text"] {
            width: 100%;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border);
            padding: 10px;
            color: white;
            border-radius: 4px;
            font-family: inherit;
            outline: none;
            box-sizing: border-box;
        }

        input[type="text"]:focus {
            border-color: var(--accent-cyan);
            box-shadow: 0 0 5px rgba(0, 243, 255, 0.2);
        }

        .result-item {
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.2s;
        }

        .result-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--accent-cyan);
        }

        .result-type {
            font-size: 10px;
            text-transform: uppercase;
            opacity: 0.5;
            margin-right: 10px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.2); }

        /* Swarm Monitoring Styles */
        .swarm-run-item {
            padding: 10px;
            margin: 5px 0;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .swarm-run-item:hover {
            background: rgba(0, 255, 65, 0.1);
            border-color: var(--accent-cyan);
        }

        .swarm-run-item.active {
            background: rgba(0, 255, 65, 0.15);
            border-color: var(--accent-cyan);
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.3);
        }

        .agent-row {
            display: grid;
            grid-template-columns: 80px 60px 80px 1fr;
            gap: 10px;
            padding: 8px;
            margin: 3px 0;
            background: rgba(0, 0, 0, 0.2);
            border-left: 3px solid transparent;
            font-family: 'Lucida Console', monospace;
            font-size: 11px;
        }

        .agent-row.running { border-left-color: var(--accent-cyan); }
        .agent-row.exited { border-left-color: #888; opacity: 0.7; }
        .agent-row.failed { border-left-color: #ff4444; }

        .agent-status-badge {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            text-align: center;
            font-weight: bold;
        }

        .agent-status-badge.running { background: rgba(0, 255, 65, 0.2); color: var(--accent-cyan); }
        .agent-status-badge.exited { background: rgba(136, 136, 136, 0.2); color: #888; }
        .agent-status-badge.failed { background: rgba(255, 68, 68, 0.2); color: #ff4444; }

        .run-header { font-size: 11px; margin-bottom: 5px; opacity: 0.7; }

        .run-stats { display: flex; gap: 15px; font-size: 10px; margin-top: 5px; }
        .stat { display: flex; align-items: center; gap: 5px; }
        .stat-value { font-weight: bold; color: var(--accent-cyan); }

        /* Node tooltip */
        #node-tooltip {
            position: fixed;
            background: rgba(0, 20, 0, 0.95);
            border: 1px solid var(--accent-cyan);
            padding: 10px 15px;
            border-radius: 4px;
            font-size: 12px;
            color: var(--accent-cyan);
            pointer-events: none;
            z-index: 2000;
            display: none;
            max-width: 400px;
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.3);
        }

        /* Loading overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            flex-direction: column;
            transition: opacity 0.5s;
        }

        #loading-overlay.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        .loading-text {
            color: var(--accent-cyan);
            font-size: 14px;
            margin-top: 20px;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Cortex stats in status bar */
        #cortex-stats {
            color: var(--accent-cyan);
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="loading-text">[SYSTEM] INITIALIZING CORTEX CONSTELLATION...</div>
    </div>

    <!-- Node Tooltip -->
    <div id="node-tooltip"></div>

    <!-- Full-screen Cortex Constellation Background -->
    <div id="cortex-background"></div>

    <div id="desktop">

        <!-- Cortex Search Panel (Floating) -->
        <div id="cortex-search-panel" class="window">
            <div class="window-header">
                <div class="window-title">Cortex Query</div>
                <div style="opacity: 0.5; cursor: pointer;">×</div>
            </div>
            <div class="window-content" style="padding: 10px;">
                <input type="text" id="cortex-search" placeholder="Search nodes... (type to query CORTEX)">
                <div id="results-list" style="background:rgba(0,10,0,0.9); border:1px solid var(--border); max-height:200px; overflow-y:auto; margin-top: 5px;"></div>
            </div>
        </div>

        <!-- Remote View Window -->
        <div id="remote-view" class="window">
            <div class="window-header">
                <div class="window-title">Ghost Browser // External Link</div>
                <div style="opacity: 0.5; cursor: pointer;">×</div>
            </div>
            <div class="window-content">
                <div style="color: var(--accent-pink); font-family: monospace; font-size: 13px;">
                    [SYSTEM] Neural link established to BRIDGE.<br>
                    [SIGNAL] Waiting for downlink from Remote Operator...
                </div>
                <hr style="border: none; border-top: 1px solid rgba(255,0,193,0.2); margin: 15px 0;">
                <div id="ghost-content" style="opacity: 0.8; font-family: 'Lucida Console', monospace;">
                    [INIT] MONITORING NEURAL UPLINK...<br>
                    [WARN] NO ACTIVE SESSION DETECTED.
                </div>
            </div>
        </div>

        <!-- Terminal Window -->
        <div id="terminal" class="window">
            <div class="window-header">
                <div class="window-title">Operator Log</div>
                <div style="opacity: 0.5; cursor: pointer;">×</div>
            </div>
            <div class="window-content" style="font-family: 'Lucida Console', monospace; background: rgba(0,0,0,0.5); color: #00ff41;">
                <div>> SYSTEM_BOOT_SEQUENCE: SUCCESS</div>
                <div>> NEO3000_OS_V1.0: ONLINE</div>
                <div>> AUTHENTICATED: OPERATOR_01</div>
                <div id="term-out"></div>
            </div>
        </div>

        <!-- Swarm Monitor Window -->
        <div id="swarm-monitor" class="window">
            <div class="window-header">
                <div class="window-title">Swarm Control // Agent Orchestrator</div>
                <div style="opacity: 0.5; cursor: pointer;">×</div>
            </div>
            <div class="window-content">
                <div class="run-header">ACTIVE SWARM RUNS:</div>
                <div id="swarm-runs-list" style="max-height: 120px; overflow-y: auto; margin-bottom: 10px;">
                    <div style="text-align: center; opacity: 0.5; padding: 15px;">
                        [SYSTEM] SCANNING FOR SWARM RUNS...
                    </div>
                </div>
                <hr style="border: none; border-top: 1px solid var(--border); margin: 10px 0;">
                <div class="run-header">AGENT STATUS:</div>
                <div id="swarm-agents-list" style="max-height: 150px; overflow-y: auto;">
                    <div style="text-align: center; opacity: 0.5; padding: 15px;">
                        [SELECT A RUN TO VIEW AGENTS]
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="status-bar">
        <div class="status-item">
            <div class="led"></div> <b>NEO3000</b> KERNEL [ACTIVE]
        </div>
        <div class="status-item">UPTIME: <b id="uptime">00:00:00</b></div>
        <div class="status-item">CORTEX: <b id="cortex-stats">LOADING...</b></div>
        <div style="flex: 1"></div>
        <div class="status-item">NODES: <b id="node-count">0</b></div>
        <div class="status-item">EDGES: <b id="edge-count">0</b></div>
    </div>

    <script>
        // ===== GLOBAL STATE =====
        let network = null;
        let allNodes = [];
        let allEdges = [];
        let selectedNodeId = null;

        // ===== UPTIME TIMER =====
        let startTime = Date.now();
        setInterval(() => {
            let diff = Date.now() - startTime;
            let h = Math.floor(diff / 3600000).toString().padStart(2, '0');
            let m = Math.floor((diff % 3600000) / 60000).toString().padStart(2, '0');
            let s = Math.floor((diff % 60000) / 1000).toString().padStart(2, '0');
            document.getElementById('uptime').innerText = `${h}:${m}:${s}`;
        }, 1000);

        // ===== WINDOW DRAGGING =====
        document.querySelectorAll('.window').forEach(win => {
            const header = win.querySelector('.window-header');
            header.onmousedown = (e) => {
                let offsetX = e.clientX - win.offsetLeft;
                let offsetY = e.clientY - win.offsetTop;
                document.querySelectorAll('.window').forEach(w => w.style.zIndex = 10);
                win.style.zIndex = 100;
                document.onmousemove = (mv) => {
                    win.style.left = (mv.clientX - offsetX) + 'px';
                    win.style.top = (mv.clientY - offsetY) + 'px';
                };
                document.onmouseup = () => { document.onmousemove = null; };
            };
        });

        // ===== TERMINAL LOG =====
        function termLog(msg, color = '#00ff41') {
            const out = document.getElementById('term-out');
            out.innerHTML += `<div style="color:${color}">> ${msg}</div>`;
            out.parentElement.scrollTop = out.parentElement.scrollHeight;
        }

        // ===== CORTEX SEARCH =====
        const searchInput = document.getElementById('cortex-search');
        searchInput.oninput = async () => {
            const q = searchInput.value;
            const list = document.getElementById('results-list');

            if (q.length < 2) {
                list.innerHTML = '';
                return;
            }

            try {
                const res = await fetch(`/api/search?q=${encodeURIComponent(q)}`);
                const data = await res.json();
                list.innerHTML = '';

                if (!data.ok || data.results.length === 0) {
                    list.innerHTML = '<div style="text-align:center; opacity:0.3; padding: 10px;">No nodes matched query.</div>';
                    return;
                }

                data.results.slice(0, 10).forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'result-item';
                    div.innerHTML = `<span class="result-type">${item.type || 'page'}</span> ${item.id}`;
                    div.onclick = () => {
                        focusNode(item.id);
                        loadEntity(item.id);
                    };
                    list.appendChild(div);
                });
            } catch (e) {
                console.error(e);
                list.innerHTML = '<div style="text-align:center; opacity:0.3; padding: 10px; color: #ff4444;">Search failed</div>';
            }
        };

        // ===== FOCUS NODE IN GRAPH =====
        function focusNode(nodeId) {
            if (!network) return;

            // Find the node
            const node = allNodes.find(n => n.id === nodeId);
            if (!node) {
                termLog(`Node not found: ${nodeId}`, '#ff4444');
                return;
            }

            // Animate to node
            network.focus(nodeId, {
                scale: 1.5,
                animation: {
                    duration: 500,
                    easingFunction: 'easeInOutQuad'
                }
            });

            // Select and highlight node
            network.selectNodes([nodeId]);
            selectedNodeId = nodeId;

            termLog(`FOCUSED: ${nodeId}`, '#00ff41');
        }

        // ===== LOAD ENTITY DETAILS =====
        async function loadEntity(id) {
            termLog(`Fetching node: ${id}`);
            try {
                const res = await fetch(`/api/entity?id=${encodeURIComponent(id)}`);
                const data = await res.json();
                if (data.ok) {
                    termLog(`SUCCESS: ${data.entity.title}`, '#00ff41');
                    // Show entity details in ghost browser
                    const ghostContent = document.getElementById('ghost-content');
                    const ghostTitle = document.querySelector('#remote-view .window-title');
                    ghostTitle.innerText = `Entity View // ${data.entity.title}`;
                    ghostContent.innerHTML = `
                        <div style="color: var(--accent-cyan); margin-bottom: 10px;">[ENTITY DATA]</div>
                        <div><b>ID:</b> ${data.entity.id}</div>
                        <div><b>Title:</b> ${data.entity.title}</div>
                        <div><b>Type:</b> ${data.entity.type || 'page'}</div>
                        ${data.entity.paths ? `<div><b>Path:</b> ${data.entity.paths.source}</div>` : ''}
                    `;
                } else {
                    termLog(`Entity not found: ${id}`, '#ff4444');
                }
            } catch (e) {
                termLog(`Error: ${e.message}`, '#ff4444');
            }
        }

        // ===== INIT FULL-SCREEN CORTEX CONSTELLATION =====
        async function initConstellation() {
            const out = document.getElementById('term-out');
            const loadingOverlay = document.getElementById('loading-overlay');

            if (typeof vis === 'undefined') {
                termLog('ERROR: VIS_NETWORK_LIBRARY_NOT_LOADED', '#ff4444');
                loadingOverlay.classList.add('fade-out');
                return;
            }

            try {
                termLog('MAPPING_VIRTUAL_TOPOLOGY...');
                const res = await fetch('/api/constellation');
                const data = await res.json();

                if (!data.ok) {
                    throw new Error('Failed to fetch constellation data');
                }

                termLog('SCANNING_CORTEX_DB...');

                const container = document.getElementById('cortex-background');

                // Transform nodes for visualization
                allNodes = data.nodes.map(n => ({
                    ...n,
                    color: {
                        background: n.group === 'folder' ? '#003300' : '#001a00',
                        border: n.group === 'folder' ? '#00ff41' : '#008f11',
                        highlight: {
                            background: '#004400',
                            border: '#00ff41'
                        },
                        hover: {
                            background: '#003300',
                            border: '#00ff41'
                        }
                    },
                    font: {
                        color: '#00ff41',
                        size: n.group === 'folder' ? 14 : 10,
                        face: 'Lucida Console'
                    },
                    shape: n.group === 'folder' ? 'diamond' : 'dot',
                    size: n.group === 'folder' ? 20 : 8,
                    borderWidth: 1,
                    borderWidthSelected: 3,
                    shadow: {
                        enabled: true,
                        color: 'rgba(0, 255, 65, 0.3)',
                        size: 10,
                        x: 0,
                        y: 0
                    }
                }));

                allEdges = data.edges.map(e => ({
                    ...e,
                    color: { color: '#004400', highlight: '#00ff41', hover: '#008f11' },
                    width: 0.5,
                    smooth: { type: 'continuous' }
                }));

                const graphData = {
                    nodes: new vis.DataSet(allNodes),
                    edges: new vis.DataSet(allEdges)
                };

                const options = {
                    nodes: {
                        fixed: false
                    },
                    edges: {
                        arrows: { to: { enabled: true, scaleFactor: 0.3 } }
                    },
                    physics: {
                        enabled: true,
                        stabilization: {
                            enabled: true,
                            iterations: 200,
                            updateInterval: 25
                        },
                        barnesHut: {
                            gravitationalConstant: -3000,
                            centralGravity: 0.1,
                            springLength: 150,
                            springConstant: 0.02,
                            damping: 0.3
                        }
                    },
                    interaction: {
                        hover: true,
                        tooltipDelay: 100,
                        zoomView: true,
                        dragView: true,
                        dragNodes: true,
                        keyboard: {
                            enabled: true,
                            speed: { x: 10, y: 10, zoom: 0.02 }
                        }
                    },
                    layout: {
                        improvedLayout: true
                    }
                };

                network = new vis.Network(container, graphData, options);

                // Update stats
                document.getElementById('node-count').textContent = allNodes.length;
                document.getElementById('edge-count').textContent = allEdges.length;
                document.getElementById('cortex-stats').textContent = `${allNodes.length} NODES MAPPED`;

                // Node click handler
                network.on("click", function(params) {
                    if (params.nodes.length > 0) {
                        const nodeId = params.nodes[0];
                        selectedNodeId = nodeId;
                        const node = allNodes.find(n => n.id === nodeId);
                        if (node) {
                            termLog(`SELECTED: ${node.label || nodeId}`, '#00ff41');
                            if (!nodeId.startsWith('dir:')) {
                                loadEntity(nodeId);
                            }
                        }
                    }
                });

                // Node hover handler for tooltip
                const tooltip = document.getElementById('node-tooltip');
                network.on("hoverNode", function(params) {
                    const node = allNodes.find(n => n.id === params.node);
                    if (node) {
                        tooltip.innerHTML = `<b>${node.label}</b><br><span style="opacity:0.7">${node.path || node.id}</span>`;
                        tooltip.style.display = 'block';
                    }
                });

                network.on("blurNode", function() {
                    tooltip.style.display = 'none';
                });

                // Update tooltip position on mouse move
                document.addEventListener('mousemove', (e) => {
                    if (tooltip.style.display === 'block') {
                        tooltip.style.left = (e.clientX + 15) + 'px';
                        tooltip.style.top = (e.clientY + 15) + 'px';
                    }
                });

                // Stabilization complete
                network.on("stabilizationIterationsDone", function() {
                    termLog('TOPOLOGY_STABILIZED', '#00ff41');
                    network.setOptions({ physics: { enabled: false } });
                });

                // Hide loading overlay
                setTimeout(() => {
                    loadingOverlay.classList.add('fade-out');
                    termLog(`CONSTELLATION_READY: ${allNodes.length} nodes, ${allEdges.length} edges`, '#00ff41');
                }, 500);

            } catch (e) {
                console.error(e);
                termLog('ERROR: CONSTELLATION_INIT_FAILURE', '#ff4444');
                termLog(e.message, '#ff4444');
                document.getElementById('cortex-stats').textContent = 'ERROR';
                loadingOverlay.classList.add('fade-out');
            }
        }

        // ===== BRIDGE POLLING =====
        const ghostContent = document.getElementById('ghost-content');
        const ghostTitle = document.querySelector('#remote-view .window-title');
        let lastHash = "";

        setInterval(async () => {
            try {
                const res = await fetch('/api/bridge/content');
                const data = await res.json();
                if (data.ok && data.content.target !== "NONE") {
                    const currentHash = btoa(data.content.text);
                    if (currentHash !== lastHash) {
                        lastHash = currentHash;
                        ghostTitle.innerText = `Ghost Browser // ${data.content.target}`;
                        ghostContent.innerHTML = data.content.text.replace(/\n/g, '<br>');
                    }
                }
            } catch (e) { }

            try {
                const res = await fetch('/api/bridge/pending');
                const data = await res.json();
                if (data.ok && data.command) {
                    termLog(`INCOMING_UPLINK: ${data.command.action}`, 'var(--accent-pink)');
                }
            } catch (e) { }
        }, 1000);

        // ===== SWARM MONITORING =====
        let selectedRunId = null;

        async function loadSwarmRuns() {
            try {
                const res = await fetch('/api/swarm/runs');
                const data = await res.json();
                const runsList = document.getElementById('swarm-runs-list');

                if (!data.ok || data.runs.length === 0) {
                    runsList.innerHTML = '<div style="text-align: center; opacity: 0.5; padding: 15px;">[NO SWARM RUNS]</div>';
                    return;
                }

                runsList.innerHTML = '';
                data.runs.forEach(run => {
                    const div = document.createElement('div');
                    div.className = 'swarm-run-item' + (selectedRunId === run.run_id ? ' active' : '');
                    const timeStr = new Date(run.started).toLocaleTimeString();
                    div.innerHTML = `
                        <div style="font-weight: bold; color: var(--accent-cyan); margin-bottom: 5px;">${run.run_id}</div>
                        <div class="run-stats">
                            <div class="stat">TOTAL: <span class="stat-value">${run.total_agents}</span></div>
                            <div class="stat">RUN: <span class="stat-value" style="color: var(--accent-cyan);">${run.running}</span></div>
                            <div class="stat">EXIT: <span class="stat-value" style="color: #888;">${run.exited}</span></div>
                            <div class="stat">FAIL: <span class="stat-value" style="color: #ff4444;">${run.failed}</span></div>
                        </div>
                    `;
                    div.onclick = () => selectRun(run.run_id);
                    runsList.appendChild(div);
                });

                if (!selectedRunId && data.runs.length > 0) {
                    selectRun(data.runs[0].run_id);
                }
            } catch (e) {
                console.error('Failed to load swarm runs:', e);
            }
        }

        async function selectRun(runId) {
            selectedRunId = runId;
            await loadSwarmAgents(runId);
            await loadSwarmRuns();
        }

        async function loadSwarmAgents(runId) {
            try {
                const res = await fetch(`/api/swarm/agents?run_id=${encodeURIComponent(runId)}`);
                const data = await res.json();
                const agentsList = document.getElementById('swarm-agents-list');

                if (!data.ok || !data.data.agents || data.data.agents.length === 0) {
                    agentsList.innerHTML = '<div style="text-align: center; opacity: 0.5; padding: 15px;">[NO AGENTS]</div>';
                    return;
                }

                agentsList.innerHTML = '';
                const header = document.createElement('div');
                header.style.cssText = 'display:grid; grid-template-columns:80px 60px 70px 1fr; gap:10px; padding:5px 8px; font-weight:bold; font-size:10px; opacity:0.5; border-bottom:1px solid var(--border); margin-bottom:5px;';
                header.innerHTML = '<div>AGENT</div><div>PID</div><div>STATUS</div><div>LAST LOG</div>';
                agentsList.appendChild(header);

                data.data.agents.forEach(agent => {
                    const div = document.createElement('div');
                    div.className = `agent-row ${agent.status}`;
                    div.style.cursor = 'pointer';
                    const lastLog = agent.last_log ? agent.last_log.substring(0, 50) : '-';
                    div.innerHTML = `
                        <div>${agent.agent_id}</div>
                        <div style="opacity: 0.7;">${agent.pid || 'N/A'}</div>
                        <div><span class="agent-status-badge ${agent.status}">${agent.status.toUpperCase()}</span></div>
                        <div style="opacity: 0.6; font-size: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${lastLog}</div>
                    `;
                    div.onclick = () => viewAgentLogs(runId, agent.agent_id);
                    agentsList.appendChild(div);
                });
            } catch (e) {
                console.error('Failed to load agents:', e);
            }
        }

        async function viewAgentLogs(runId, agentId) {
            termLog(`FETCHING_LOGS: ${agentId}`, 'var(--accent-pink)');
            try {
                const res = await fetch(`/api/swarm/logs?run_id=${encodeURIComponent(runId)}&agent_id=${encodeURIComponent(agentId)}&lines=15`);
                const data = await res.json();
                if (data.ok) {
                    termLog(`LOG_STREAM [${agentId}]:`, '#00ff41');
                    data.logs.forEach(line => {
                        const out = document.getElementById('term-out');
                        out.innerHTML += `<div style="font-size: 10px; opacity: 0.8; margin-left: 10px;">${line}</div>`;
                    });
                }
            } catch (e) {
                termLog('ERROR: LOG_FETCH_FAILED', '#ff4444');
            }
        }

        // Poll swarm status every 2 seconds
        setInterval(() => {
            loadSwarmRuns();
            if (selectedRunId) loadSwarmAgents(selectedRunId);
        }, 2000);

        // ===== INITIALIZATION =====
        window.onload = async () => {
            termLog('BOOTING_NEO3000...');
            await initConstellation();
            setTimeout(loadSwarmRuns, 500);
        };

        // Add simulation button
        const rvContent = document.querySelector('#remote-view .window-content');
        const simBtn = document.createElement('button');
        simBtn.innerText = "ACTIVATE NEURAL LINK";
        simBtn.style.cssText = "margin-top:10px; background:#008f11; color:white; border:1px solid #00ff41; padding:5px 10px; cursor:pointer; font-family:'Lucida Console',monospace;";
        simBtn.onclick = async () => {
            termLog('INJECTING_REMOTE_CONTENT...');
            await fetch('/api/bridge/simulate');
        };
        rvContent.appendChild(simBtn);
    </script>
</body>

</html>
