..........F.F...                                                         [100%]
================================== FAILURES ===================================
_________________ test_capability_pinned_routes_and_verifies __________________

tmp_path = WindowsPath('C:/Users/rene_/AppData/Local/Temp/pytest-of-Reneshizzle/pytest-151/test_capability_pinned_routes_0')

    def test_capability_pinned_routes_and_verifies(tmp_path: Path) -> None:
        pipeline_id = "ags-capability-pins-ok"
        plan_path = tmp_path / "plan.json"
        plan_path.write_text(json.dumps({"plan_version": "1.0", "steps": [{"step_id": "s1", "capability_hash": CAP}]}), encoding="utf-8")
    
        pins_path = tmp_path / "PINS.json"
        pins_path.write_bytes(_canon({"pins_version": "1.0.0", "allowed_capabilities": [CAP]}))
    
        env = dict(os.environ)
        env["CATALYTIC_PINS_PATH"] = str(pins_path)
    
        # The v1 capability is pinned to a concrete ant-worker command that expects these files.
        reg_root = REPO_ROOT / "CONTRACTS" / "_runs" / "_tmp" / "phase65_registry"
        task_path = reg_root / "task.json"
        in_path = reg_root / "in.txt"
        out_path = reg_root / "out.txt"
        (reg_root / "domain").mkdir(parents=True, exist_ok=True)
        in_path.write_bytes(b"PHASE66\n")
        task_path.write_text(
            json.dumps(
                {
                    "task_id": "ant-worker-copy",
                    "task_type": "file_operation",
                    "operation": "copy",
                    "verify_integrity": True,
                    "timestamp": "CATALYTIC-DPT-02_CONFIG",
                    "files": [{"source": str(in_path), "destination": str(out_path)}],
                }
            ),
            encoding="utf-8",
        )
    
        pipeline_dir = REPO_ROOT / "CONTRACTS" / "_runs" / "_pipelines" / pipeline_id
        run_dir = REPO_ROOT / "CONTRACTS" / "_runs" / "pipeline-ags-capability-pins-ok-s1-a1"
    
        try:
            _rm(pipeline_dir)
            _rm(run_dir)
            _rm(reg_root)
            (reg_root / "domain").mkdir(parents=True, exist_ok=True)
            in_path.write_bytes(b"PHASE66\n")
            task_path.write_text(
                json.dumps(
                    {
                        "task_id": "ant-worker-copy",
                        "task_type": "file_operation",
                        "operation": "copy",
                        "verify_integrity": True,
                        "timestamp": "CATALYTIC-DPT-02_CONFIG",
                        "files": [{"source": str(in_path), "destination": str(out_path)}],
                    }
                ),
                encoding="utf-8",
            )
    
            r_route = _run([sys.executable, "-m", "TOOLS.ags", "route", "--plan", str(plan_path), "--pipeline-id", pipeline_id], env=env)
            assert r_route.returncode == 0, r_route.stdout + r_route.stderr
    
            r_run = _run([sys.executable, "-m", "TOOLS.ags", "run", "--pipeline-id", pipeline_id, "--strict", "--allow-dirty-tracked"], env=env)
>           assert r_run.returncode == 0, r_run.stdout + r_run.stderr
E           AssertionError: {"verdict":"ALLOW","reasons":[],"normalized_paths":{"read":["CONTRACTS/_runs/_pipelines/ags-capability-pins-ok/PIPELINE.json","CONTRACTS/_runs/_pipelines/ags-capability-pins-ok/steps/s1/JOBSPEC.json"],"write":["CONTRACTS/_runs","CONTRACTS/_runs/_pipelines/ags-capability-pins-ok"]},"policy_version":"1"}
E             [catalytic] Starting catalytic run: pipeline-ags-capability-pins-ok-s1-a1
E             [catalytic] Phase 0: Preflight validation...
E             [catalytic] Preflight passed: JobSpec is valid
E             [catalytic] Phase 1: Capturing pre-snapshots...
E             [catalytic] Snapshots pre: CONTRACTS\_runs\_tmp\phase65_registry\domain (0 files)
E             [catalytic] Memoization MISS: f5f8a855b952df724c66a505538ad6f94a3fefd11bdbd09846761b279e2fdf98
E             [catalytic] Phase 2: Executing command: python3 CATALYTIC-DPT/SKILLS/ant-worker/scripts/run.py CONTRACTS/_runs/_tmp/phase65_registry/task.json CONTRACTS/_runs/_tmp/phase65_registry/result.json
E             [catalytic] Command exited with code 9009
E             [catalytic] Phase 3: Capturing post-snapshots...
E             [catalytic] Snapshots post: CONTRACTS\_runs\_tmp\phase65_registry\domain (0 files)
E             [catalytic] Phase 4: Verifying restoration...
E             [catalytic] SUCCESS: Catalytic domains fully restored
E             [catalytic] Phase 5: Writing canonical artifact set...
E             [catalytic] Canonical artifact set written to D:\CCC 2.0\AI\agent-governance-system\CONTRACTS\_runs\pipeline-ags-capability-pins-ok-s1-a1
E             [catalytic] PROOF.json: verified=True, condition=RESTORED_IDENTICAL
E             AGS: running pipeline
E             FAIL pipeline run rc=2
E             DEBUG: execute cmd=['python3', 'CATALYTIC-DPT/SKILLS/ant-worker/scripts/run.py', 'CONTRACTS/_runs/_tmp/phase65_registry/task.json', 'CONTRACTS/_runs/_tmp/phase65_registry/result.json']
E             Python was not found; run without arguments to install from the Microsoft Store, or disable this shortcut from Settings > Apps > Advanced app settings > App execution aliases.
E             [catalytic] FAIL: Command exited with code 9009.
E             ERROR: step s1 failed: rc=9009
E             
E           assert 2 == 0
E            +  where 2 = CompletedProcess(args=['C:\\Users\\rene_\\AppData\\Local\\Programs\\Python\\Python311\\python.exe', '-m', 'TOOLS.ags',...settings > App execution aliases.\n[catalytic] FAIL: Command exited with code 9009.\nERROR: step s1 failed: rc=9009\n").returncode

CATALYTIC-DPT\TESTBENCH\test_ags_phase6_capability_pins.py:92: AssertionError
________ test_verify_rejects_unpinned_even_if_pipeline_artifact_exists ________

tmp_path = WindowsPath('C:/Users/rene_/AppData/Local/Temp/pytest-of-Reneshizzle/pytest-151/test_verify_rejects_unpinned_e0')

    def test_verify_rejects_unpinned_even_if_pipeline_artifact_exists(tmp_path: Path) -> None:
        pipeline_id = "ags-capability-pins-verify-bypass"
        pipeline_dir = REPO_ROOT / "CONTRACTS" / "_runs" / "_pipelines" / pipeline_id
        run_id = "pipeline-ags-capability-pins-verify-bypass-s1-a1"
        run_dir = REPO_ROOT / "CONTRACTS" / "_runs" / run_id
    
        pins_path = tmp_path / "PINS.json"
        pins_path.write_bytes(_canon({"pins_version": "1.0.0", "allowed_capabilities": []}))
    
        env = dict(os.environ)
        env["CATALYTIC_PINS_PATH"] = str(pins_path)
    
        reg_root = REPO_ROOT / "CONTRACTS" / "_runs" / "_tmp" / "phase65_registry"
        task_path = reg_root / "task.json"
        in_path = reg_root / "in.txt"
        out_path = reg_root / "out.txt"
    
        try:
            _rm(pipeline_dir)
            _rm(run_dir)
            _rm(reg_root)
            (reg_root / "domain").mkdir(parents=True, exist_ok=True)
            in_path.write_bytes(b"PHASE66\n")
            task_path.write_text(
                json.dumps(
                    {
                        "task_id": "ant-worker-copy",
                        "task_type": "file_operation",
                        "operation": "copy",
                        "verify_integrity": True,
                        "timestamp": "CATALYTIC-DPT-02_CONFIG",
                        "files": [{"source": str(in_path), "destination": str(out_path)}],
                    }
                ),
                encoding="utf-8",
            )
    
            # Create a real run with the pinned capability (using default pins).
            plan_ok = tmp_path / "plan_ok.json"
            plan_ok.write_text(json.dumps({"plan_version": "1.0", "steps": [{"step_id": "s1", "capability_hash": CAP}]}), encoding="utf-8")
            r_route_ok = subprocess.run(
                [sys.executable, "-m", "TOOLS.ags", "route", "--plan", str(plan_ok), "--pipeline-id", pipeline_id],
                cwd=str(REPO_ROOT),
                capture_output=True,
                text=True,
            )
            assert r_route_ok.returncode == 0, r_route_ok.stdout + r_route_ok.stderr
            r_run_ok = subprocess.run(
                [sys.executable, "-m", "TOOLS.ags", "run", "--pipeline-id", pipeline_id, "--strict", "--allow-dirty-tracked"],
                cwd=str(REPO_ROOT),
                capture_output=True,
                text=True,
            )
>           assert r_run_ok.returncode == 0, r_run_ok.stdout + r_run_ok.stderr
E           AssertionError: {"verdict":"ALLOW","reasons":[],"normalized_paths":{"read":["CONTRACTS/_runs/_pipelines/ags-capability-pins-verify-bypass/PIPELINE.json","CONTRACTS/_runs/_pipelines/ags-capability-pins-verify-bypass/steps/s1/JOBSPEC.json"],"write":["CONTRACTS/_runs","CONTRACTS/_runs/_pipelines/ags-capability-pins-verify-bypass"]},"policy_version":"1"}
E             [catalytic] Starting catalytic run: pipeline-ags-capability-pins-verify-bypass-s1-a1
E             [catalytic] Phase 0: Preflight validation...
E             [catalytic] Preflight passed: JobSpec is valid
E             [catalytic] Phase 1: Capturing pre-snapshots...
E             [catalytic] Snapshots pre: CONTRACTS\_runs\_tmp\phase65_registry\domain (0 files)
E             [catalytic] Memoization MISS: f5f8a855b952df724c66a505538ad6f94a3fefd11bdbd09846761b279e2fdf98
E             [catalytic] Phase 2: Executing command: python3 CATALYTIC-DPT/SKILLS/ant-worker/scripts/run.py CONTRACTS/_runs/_tmp/phase65_registry/task.json CONTRACTS/_runs/_tmp/phase65_registry/result.json
E             [catalytic] Command exited with code 9009
E             [catalytic] Phase 3: Capturing post-snapshots...
E             [catalytic] Snapshots post: CONTRACTS\_runs\_tmp\phase65_registry\domain (0 files)
E             [catalytic] Phase 4: Verifying restoration...
E             [catalytic] SUCCESS: Catalytic domains fully restored
E             [catalytic] Phase 5: Writing canonical artifact set...
E             [catalytic] Canonical artifact set written to D:\CCC 2.0\AI\agent-governance-system\CONTRACTS\_runs\pipeline-ags-capability-pins-verify-bypass-s1-a1
E             [catalytic] PROOF.json: verified=True, condition=RESTORED_IDENTICAL
E             AGS: running pipeline
E             FAIL pipeline run rc=2
E             DEBUG: execute cmd=['python3', 'CATALYTIC-DPT/SKILLS/ant-worker/scripts/run.py', 'CONTRACTS/_runs/_tmp/phase65_registry/task.json', 'CONTRACTS/_runs/_tmp/phase65_registry/result.json']
E             Python was not found; run without arguments to install from the Microsoft Store, or disable this shortcut from Settings > Apps > Advanced app settings > App execution aliases.
E             [catalytic] FAIL: Command exited with code 9009.
E             ERROR: step s1 failed: rc=9009
E             
E           assert 2 == 0
E            +  where 2 = CompletedProcess(args=['C:\\Users\\rene_\\AppData\\Local\\Programs\\Python\\Python311\\python.exe', '-m', 'TOOLS.ags',...settings > App execution aliases.\n[catalytic] FAIL: Command exited with code 9009.\nERROR: step s1 failed: rc=9009\n").returncode

CATALYTIC-DPT\TESTBENCH\test_ags_phase6_capability_pins.py:177: AssertionError
============================== warnings summary ===============================
CATALYTIC-DPT/TESTBENCH/test_cortex_integration.py::test_system1_db
  C:\Users\rene_\AppData\Local\Programs\Python\Python311\Lib\site-packages\_pytest\python.py:170: PytestReturnNotNoneWarning: Test functions should return None, but CATALYTIC-DPT/TESTBENCH/test_cortex_integration.py::test_system1_db returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

CATALYTIC-DPT/TESTBENCH/test_cortex_integration.py::test_cortex_indexer
  C:\Users\rene_\AppData\Local\Programs\Python\Python311\Lib\site-packages\_pytest\python.py:170: PytestReturnNotNoneWarning: Test functions should return None, but CATALYTIC-DPT/TESTBENCH/test_cortex_integration.py::test_cortex_indexer returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

CATALYTIC-DPT/TESTBENCH/test_cortex_integration.py::test_search_functionality
  C:\Users\rene_\AppData\Local\Programs\Python\Python311\Lib\site-packages\_pytest\python.py:170: PytestReturnNotNoneWarning: Test functions should return None, but CATALYTIC-DPT/TESTBENCH/test_cortex_integration.py::test_search_functionality returned <class 'bool'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED CATALYTIC-DPT/TESTBENCH/test_ags_phase6_capability_pins.py::test_capability_pinned_routes_and_verifies
FAILED CATALYTIC-DPT/TESTBENCH/test_ags_phase6_capability_pins.py::test_verify_rejects_unpinned_even_if_pipeline_artifact_exists
2 failed, 14 passed, 3 warnings in 40.20s
