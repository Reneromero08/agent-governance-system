---
phase: 2
task_id: "2.4"
slug: "crypto-safe-packs"
policy_canon_sha256: "29ed1cec0104314dea9bb5844e9fd7c15a162313ef7cc3a19e8b898d9cea2624"
guide_canon_sha256: "9acc1b9772579720e3c8bc19a80a9a3908323b411c6d06d04952323668f4efe4"
depends_on: []
primary_model: "Claude 3.5 Sonnet (Reasoning: High)"
fallback_chain: ["GPT-5.1-Codex-Max (Reasoning: Medium)"]
receipt_path: "LAW/CONTRACTS/_runs/_tmp/prompts/2.4_crypto-safe-packs/receipt.json"
report_path: "LAW/CONTRACTS/_runs/_tmp/prompts/2.4_crypto-safe-packs/REPORT.md"
max_report_lines: 800
---

## ROLE + MODEL
- You are an AGS executor operating inside this repo.
- You must follow repo LAW/CANON precedence and contracts.
- You must follow NAVIGATION/PROMPTS/1_PROMPT_POLICY_CANON.md and NAVIGATION/PROMPTS/2_PROMPT_GENERATOR_GUIDE_FINAL.md.

## GOAL
Implement **Phase 2.4: Crypto-Safe Packs & Protected Artifacts**.
The goal is to prevent "download = extraction" by sealing protected artifacts (vectors, indexes, proof outputs) for public distribution while keeping verification mechanical.

## SCOPE (WRITE ALLOWLIST)
- `CAPABILITY/PRIMITIVES/crypto_seal.py` (New)
- `CAPABILITY/PRIMITIVES/protected_registry.py` (New)
- `CAPABILITY/TESTBENCH/integration/test_crypto_safe.py` (New)
- `NAVIGATION/PROOFS/CRYPTO_SAFE/` (New directory)
- Updates to `MEMORY/LLM_PACKER/Engine/packer/core.py` (Integration)
- Updates to `CHANGELOG.md` and `NAVIGATION/ROADMAPS/AGS_ROADMAP_MASTER.md`

## RELEASE CRITERIA
- [ ] Protected Inventory Defined: Scanner detects protected artifacts.
- [ ] Git Hygiene: _PACK_RUN/ outputs never tracked.
- [ ] Sealing Primitive: `crypto_seal` / `crypto_open` implemented (age-encryption or similar).
- [ ] Packer Integration: Packer seals protected artifacts during public pack generation.
- [ ] Verification: `crypto_safe_verify` checks integrity without needing decryption keys.
- [ ] Tests: Fixtures for missing seal, tampered seal, and plaintext leaks.

## PLAN (EXPLICIT STEPS)
1. **Inventory & Scanner (2.4.1)**:
   - Define `ProtectedRegistry` identifying patterns (e.g., `*.vec`, `*.index`, `PROOF_BUNDLE.json`).
   - Implement scanner to detect these in working tree.

2. **Sealing Primitive (2.4.3)**:
   - Implement `crypto_seal(input, output, meta)` -> receipt.
   - Implement `crypto_open(sealed, output, key)` -> receipt.
   - Use deterministic nonce generation where possible or include nonce in receipt.
   - Fail-closed on any crypto error.

3. **Packer Integration (2.4.5)**:
   - Hook into `_PACK_RUN` logic.
   - If mode=PUBLIC, apply sealing to all protected artifacts.
   - Emit `SEALED_ARTIFACTS.json` manifest.

4. **Verifier & Tests (2.4.6 - 2.4.7)**:
   - Implement `crypto_safe_verify()`: Check sealed manifest integrity and absence of plaintext leaks.
   - Create tests proving:
     - Plaintext leak -> FAIL
     - Tampered seal -> FAIL
     - Missing seal -> FAIL

5. **Finalize**:
   - Update Roadmap 2.4 to [x].
   - Emit Receipts & Report.

## RECOVERY
- If `cryptography` lib is missing, fallback to `openssl` CLI or explicit error (fail-closed).
- If sealing fails, abort pack generation (do not release plaintext).
- If verification fails, do not sign/release the pack.
