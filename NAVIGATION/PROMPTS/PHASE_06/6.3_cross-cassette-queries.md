---
phase: 6
task_id: "6.3"
slug: "cross-cassette-queries"
policy_canon_sha256: "29ed1cec0104314dea9bb5844e9fd7c15a162313ef7cc3a19e8b898d9cea2624"
guide_canon_sha256: "9acc1b9772579720e3c8bc19a80a9a3908323b411c6d06d04952323668f4efe4"
depends_on: []
primary_model: "Claude Opus 4.5 (Thinking) (Reasoning: High)"
fallback_chain: ["Claude Sonnet (Reasoning: High)", "Gemini Pro (Reasoning: High)"]
receipt_path: "LAW/CONTRACTS/_runs/_tmp/prompts/6.3_cross-cassette-queries/receipt.json"
report_path: "LAW/CONTRACTS/_runs/_tmp/prompts/6.3_cross-cassette-queries/REPORT.md"
max_report_lines: 600
---
## ROLE + MODEL
- You are an AGS executor operating inside this repo.
- You must follow repo LAW/CANON precedence and contracts.
- You must follow NAVIGATION/PROMPTS/1_PROMPT_POLICY_CANON.md and NAVIGATION/PROMPTS/2_PROMPT_GENERATOR_GUIDE_FINAL.md.
- Primary model: Claude Opus 4.5 (Thinking) (Reasoning: High)
- Fallback chain: use only if required to reach DONE = GREEN.

## GOAL
Execute task **6.3** (cross-cassette-queries) exactly as specified, without scope drift.

Source prompt body (carried forward, normalized):

---
Model: Claude Opus 4.5 (Thinking)
Thinking: High

```text
ROLE + MODEL
- Primary: Claude Opus 4.5 (Thinking) (Thinking: High)
- Fallback chain: Claude Sonnet 4.5 (Thinking) -> GPT-5.1-Codex-Max -> Gemini 3 Pro (High)

GOAL
Implement **6.3 Cross-Cassette Queries (M.3)** by completing its unchecked checklist items from the roadmap. Do not start adjacent sections or “helpful extras”.

SCOPE LOCK
- This prompt implements ONLY this roadmap section.
- Hard rule: no refactors that are not required by the section’s checklist.
- If a checklist item cannot be satisfied without expanding scope, FAIL-CLOSED: emit receipt+report with verdict=FAIL and stop without broadening scope.

SCOPE (WRITE ALLOWLIST)
- Allowed writes (minimal and necessary only):
  - NAVIGATION/ROADMAPS/AGS_ROADMAP_MASTER.md (only if section requires update)
  - LAW/CONTRACTS/_runs/_tmp/prompts/6.3_cross-cassette-queries/  (receipts + report only)
- Allowed deletes/renames:
  - None by default. If absolutely required, justify in REPORT and keep within allowlist.
- Forbidden (absolute):
  - Any writes under `LAW/CANON/`, `.git/`, `BUILD/`, and any other governance roots not directly required.
  - Any “cleanup sweep” unrelated to the checklist.

REQUIRED FACTS (DERIVE, DON’T Guess)
- Repo sanity:
  - `git rev-parse --show-toplevel`
  - `git status --porcelain`
- Extract the exact checklist items for THIS section (source of truth):
  - python -c "import sys,re;from pathlib import Path;from itertools import takewhile;p=Path('NAVIGATION/ROADMAPS/AGS_ROADMAP_MASTER.md');s=p.read_text(encoding='utf-8').splitlines();t='6.3 Cross-Cassette Queries (M.3)';i=next((j for j,l in enumerate(s) if l.strip()=='## '+t),-1);sys.exit(print('MISSING_SECTION_HEADING') or 2) if i<0 else [print(m.group(1).strip()) for l in takewhile(lambda x:not x.startswith('## '),s[i+1:]) if (m:=re.match(r'^\s*-\s*\[ \]\s*(.+)$',l))]" (must exit 0 or hard fail)
- Identify the minimal touch set BEFORE editing:
  - `rg -n "6.3" -S .`
  - `rg -n "6.3" -S NAVIGATION/ROADMAPS/AGS_ROADMAP_MASTER.md`
- If a required file/path is missing:
  - First attempt to locate it via `rg`/`find`/`ls`.
  - If still missing, FAIL-CLOSED (no speculative creation). Record as an error in REPORT and set verdict=FAIL.

PLAN
1) Map each checklist item to concrete file changes and tests that will prove it.
2) Implement in small steps, keeping diffs constrained.
3) Add mechanical proofs (tests, invariants docs, schema updates) only as required by checklist.
4) Validate with the narrowest relevant commands, then re-run broader tests if risk justifies.
5) Produce receipt+report. Commit only if PASS.

VALIDATION (DO NOT INVENT COMMANDS)
- Always run at least:
  - `pytest -q`
- Run memory-focused tests:
  - `pytest -q CAPABILITY/TESTBENCH/memory -q` (if present)
  - Otherwise: `pytest -q` and include the discovered nearest test path in REPORT.

ARTIFACTS (RECEIPTS + REPORT)
- Receipt:
  - Path: LAW/CONTRACTS/_runs/_tmp/prompts/6.3_cross-cassette-queries/receipt.json
  - JSON, deterministic: sorted keys, stable ordering for lists.
  - Include:
    - section_title, section_slug, timestamp_utc
    - git: HEAD before, HEAD after, branch
    - changed_files: ordered list (from `git diff --name-only`)
    - commands_run: ordered list with exit codes
    - tests_run: ordered list with exit codes
    - verdict: PASS/FAIL
    - errors: ordered list
- Report:
  - Path: LAW/CONTRACTS/_runs/_tmp/prompts/6.3_cross-cassette-queries/REPORT.md
  - Must include:
    - Checklist coverage (each item with evidence)
    - What changed (file list)
    - Proofs (tests/commands + results)
    - Any deviations (should be none) and why
    - Next recommended section ID (if PASS)

EXIT CRITERIA
- [ ] [GLOBAL] All relevant tests pass (task is incomplete until green).
- [ ] [GLOBAL] Receipts emitted (inputs, outputs, hashes, commands run, exit status).
- [ ] [GLOBAL] Human-readable report emitted (what changed, why, how verified, how to reproduce).
- [ ] [GLOBAL] Scope respected (explicit allowlist for writes; deletions/renames only if explicitly scoped).
- [ ] 6.3.1 Implement `cassette_network_query(query, limit)` (M.3.1)
- [ ] 6.3.2 Implement `cassette_stats()` (M.3.2)
- [ ] 6.3.3 Capability-based routing (query only relevant cassettes) (M.3.3)
- [ ] 6.3.4 Merge and rerank results by similarity score (M.3.4)
- [ ] Cross-cassette results include provenance + similarity scores
- [ ] Reranking deterministic for fixed inputs

```
---

## SCOPE (WRITE ALLOWLIST)
- Allowed writes: only files required by this task; you must enumerate the exact file paths in your report *before* editing them.
- Allowed deletes/renames: only within the same allowlist, and only if necessary to satisfy the task.
- Forbidden writes: everything else.

## REQUIRED FACTS (VERIFY, DO NOT GUESS)
- UNKNOWN_BLOCKER: if a required fact cannot be verified, stop the task with result = BLOCKED_UNKNOWN.
- UNKNOWN_DEFERRABLE: only allowed as `FILL_ME__<KEY>` tokens inside this section.

Preflight token policy:
- Executor scans for `FILL_ME__` tokens.
- If any token is unresolved, stop with result = BLOCKED_UNKNOWN.
- If tokens are resolved, the values must satisfy the same Verify via checks.

Required repo reality checks:
- Verify repo root and target paths exist (ls, stat).
- Verify any referenced scripts or commands exist before invoking.

## PLAN (EXPLICIT STEPS)
1) Preflight: enumerate intended edits and confirm they are within SCOPE allowlist.
2) Implement: perform the task steps from the Source prompt body above.
3) Record: capture commands run and outputs in the report.
4) Validate: run required checks and tests until DONE = GREEN.
5) Write artifacts: receipt JSON and report at the declared paths.

## VALIDATION (DONE = GREEN)
- Run the task-specific verification steps described in the Source prompt body.
- If `scripts/lint-prompt.sh` exists, run it via `bash` when touching prompt-pack content (requires bash-compatible shell, e.g. WSL). Apply exit-code rules:
  - exit 1 blocks and stops
  - exit 2 is a warning (record it and continue)
- DONE = GREEN only when all validations pass and scope remained bounded.

## ARTIFACTS (RECEIPT + REPORT)
- receipt_path: LAW/CONTRACTS/_runs/_tmp/prompts/6.3_cross-cassette-queries/receipt.json
- report_path: LAW/CONTRACTS/_runs/_tmp/prompts/6.3_cross-cassette-queries/REPORT.md

Receipt JSON required fields:
- task_id, timestamp_utc, primary_model, fallback_chain, policy_canon_sha256, guide_canon_sha256,
  depends_on, receipt_path, report_path, allowed_writes, allowed_deletes_renames,
  unknowns_or_missing_inputs, commands_run, validations, inputs, outputs, result

Result enum: OK | VERIFICATION_FAILED | BLOCKED_UNKNOWN | INTERNAL_ERROR

## EXIT CRITERIA
- [ ] Task completed per Source prompt body
- [ ] All validations pass (DONE = GREEN)
- [ ] Receipt + report written to declared paths
- [ ] No scope drift (only allowlisted files touched)
