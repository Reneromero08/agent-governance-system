---
phase: 9
task_id: "9.2"
slug: "task-queue-primitives"
policy_canon_sha256: "29ed1cec0104314dea9bb5844e9fd7c15a162313ef7cc3a19e8b898d9cea2624"
guide_canon_sha256: "9acc1b9772579720e3c8bc19a80a9a3908323b411c6d06d04952323668f4efe4"
depends_on: ["8.1", "8.2", "8.3", "8.4", "8.5"]
primary_model: "Claude Sonnet 4.5 (Thinking) (Reasoning: High)"
fallback_chain: ["Claude Sonnet (Reasoning: High)", "Gemini Pro (Reasoning: High)"]
receipt_path: "LAW/CONTRACTS/_runs/_tmp/prompts/9.2_task-queue-primitives/receipt.json"
report_path: "LAW/CONTRACTS/_runs/_tmp/prompts/9.2_task-queue-primitives/REPORT.md"
max_report_lines: 600
---
## ROLE + MODEL
- You are an AGS executor operating inside this repo.
- You must follow repo LAW/CANON precedence and contracts.
- You must follow NAVIGATION/PROMPTS/1_PROMPT_POLICY_CANON.md and NAVIGATION/PROMPTS/2_PROMPT_GENERATOR_GUIDE_FINAL.md.
- Primary model: Claude Sonnet 4.5 (Thinking) (Reasoning: High)
- Fallback chain: use only if required to reach DONE = GREEN.

## GOAL
Execute task **9.2** (Task Queue Primitives (Z.6.2)) exactly as specified, without scope drift.

## CONTEXT
Implement core task queue primitives for swarm coordination (dispatch, ack, complete).

## OBJECTIVE
Build reliable task queue primitives that support distributed agent coordination.

## SCOPE (WRITE ALLOWLIST)
- Allowed writes: only files required by this task; you must enumerate the exact file paths in your report *before* editing them.
- Allowed deletes/renames: only within the same allowlist, and only if necessary to satisfy the task.
- Forbidden writes: everything else.

## REQUIRED FACTS (VERIFY, DO NOT GUESS)
- UNKNOWN_BLOCKER: if a required fact cannot be verified, stop the task with result = BLOCKED_UNKNOWN.
- UNKNOWN_DEFERRABLE: only allowed as `FILL_ME__<KEY>` tokens inside this section.

Preflight token policy:
- Executor scans for `FILL_ME__` tokens.
- If any token is unresolved, stop with result = BLOCKED_UNKNOWN.
- If tokens are resolved, the values must satisfy the same Verify via checks.

Required repo reality checks:
- Verify repo root and target paths exist (ls, stat).
- Verify any referenced scripts or commands exist before invoking.

## PLAN (EXPLICIT STEPS)
1) Preflight: enumerate intended edits and confirm they are within SCOPE allowlist.
2) Implement: perform the task steps from the checklist below.
3) Record: capture commands run and outputs in the report.
4) Validate: run required checks and tests until DONE = GREEN.
5) Write artifacts: receipt JSON and report at the declared paths.

## CHECKLIST
- [ ] 9.2.1 Design dispatch primitive (enqueue task)
- [ ] 9.2.2 Implement acknowledgment mechanism
- [ ] 9.2.3 Build completion/failure signaling
- [ ] 9.2.4 Add persistence and retry logic

## VALIDATION (DONE = GREEN)
- Run the task-specific verification steps described above.
- If `CAPABILITY/TOOLS/linters/lint_prompt_pack.sh` exists, run it via `bash` when touching prompt-pack content (requires bash-compatible shell, e.g. WSL). Apply exit-code rules:
  - exit 1 blocks and stops
  - exit 2 is a warning (record it and continue)
- DONE = GREEN only when all validations pass and scope remained bounded.

## ARTIFACTS (RECEIPT + REPORT)
- receipt_path: LAW/CONTRACTS/_runs/_tmp/prompts/9.2_task-queue-primitives/receipt.json
- report_path: LAW/CONTRACTS/_runs/_tmp/prompts/9.2_task-queue-primitives/REPORT.md

Receipt JSON required fields:
- task_id, timestamp_utc, primary_model, fallback_chain, policy_canon_sha256, guide_canon_sha256,
  depends_on, receipt_path, report_path, allowed_writes, allowed_deletes_renames,
  unknowns_or_missing_inputs, commands_run, validations, inputs, outputs, result

Result enum: OK | VERIFICATION_FAILED | BLOCKED_UNKNOWN | INTERNAL_ERROR

## EXIT CRITERIA
- [ ] Task completed per checklist
- [ ] All validations pass (DONE = GREEN)
- [ ] Receipt + report written to declared paths
- [ ] No scope drift (only allowlisted files touched)
