<!-- CONTENT_HASH: b9f58f32ff24ff0607f35a47177dd83b8a497caf001c862f852d4813f04a9b31 -->

# PHASE_2_REPORT.md

## CAT_CHAT (Catalytic Chat) — Phase 2 Report (Symbol Registry + Symbol Resolution)

**Date generated:** 2026-01-01  
**Phase scope:** Phase 2.1 (Symbol Registry) + Phase 2.2 (Symbol Resolution + Expansion Cache)  
**Primary evidence:** repo-combined artifact + handoffs in this chat  
**Note on opncd.ai link:** The share URL could not be fetched from this environment (`(400) OK`), so this report is reconstructed from the uploaded CAT_CHAT artifacts and handoffs.

---

## 0) Phase 2 intent (what Phase 2 was for)

Phase 2 introduces **stable, reusable references** (`@Symbols`) to **Phase 1 Sections**, plus a **bounded resolver** that expands those symbols into payloads deterministically and caches expansions per run.

- Phase 2.1 delivers the **registry**: `@Symbol -> section_id (+ default_slice)` with validations and CLI.
- Phase 2.2 delivers the **resolver**: `resolve(@Symbol, slice, run_id) -> (payload, cache_hit)` plus expansion cache (SQLite + JSONL fallback).

---

## 1) Phase 2.1 — Symbol Registry (what was built)

### 1.1 Artifact + data model

**SYMBOLS artifact mapping** `@Symbol` → `section_id` (target_ref), with optional `default_slice` and enforced conventions.  
Docs checklist and command surface recorded in Phase 2.1 doc. fileciteturn12file1L14-L25

**Symbol fields (as implemented and documented):**
- `symbol_id` (TEXT, PRIMARY KEY) must start with `@`
- `target_type` must equal `SECTION` (Phase 2.1 restriction)
- `target_ref` (section_id)
- `default_slice` optional, validated, and **must not be `ALL`**
- `created_at`, `updated_at` (ISO8601) fileciteturn12file3L9-L16

### 1.2 Substrate support (dual substrate)

**SQLite primary**
- Creates `symbols` table (FK to `sections(section_id)` ON DELETE CASCADE)
- Indexes: `idx_symbols_target`, `idx_symbols_created` fileciteturn12file0L82-L96

**JSONL fallback**
- `symbols.jsonl` under the cortex output directory (one JSON record per line). fileciteturn12file3L17-L20 fileciteturn12file4L81-L85

### 1.3 Fail-closed validation rules

Validation rules are explicitly implemented as fail-closed checks:

- `symbol_id` must start with `@`, not empty, unique (duplicate check before insert). fileciteturn12file0L52-L55 fileciteturn12file0L97-L103
- `target_ref` must exist in SECTION_INDEX (checked via `SectionIndexer.get_section_by_id`). fileciteturn12file0L7-L12 fileciteturn12file3L38-L41
- `default_slice` parsed by Phase 1 SliceResolver; rejects invalid slices; explicitly rejects `ALL`. fileciteturn12file0L25-L32 fileciteturn12file3L42-L45

### 1.4 Determinism and ordering

- Listing order is deterministic:
  - SQLite: `ORDER BY symbol_id`
  - JSONL: stable sort by `symbol_id` fileciteturn12file3L96-L101
- Timestamp semantics:
  - `created_at` set on creation
  - `updated_at == created_at` (no updates supported in Phase 2.1) fileciteturn12file3L102-L105

### 1.5 CLI commands added

Documented Phase 2.1 CLI surface: fileciteturn12file1L20-L25

- `symbols add`  
  `python -m catalytic_chat.cli symbols add @... --section <section_id> [--default-slice "..."]` fileciteturn12file3L53-L60
- `symbols get` fileciteturn12file3L61-L71
- `symbols list [--prefix ...]` fileciteturn12file3L72-L84
- `symbols verify` (verifies registry entries against invariants) fileciteturn12file3L85-L94

### 1.6 Core implementation file(s)

- `catalytic_chat/symbol_registry.py`
  - Implements the `Symbol` dataclass and `SymbolRegistry` with dual substrate support and validations. fileciteturn12file4L43-L85
  - Creates `symbols` table in SQLite on demand (`CREATE TABLE IF NOT EXISTS ...`). fileciteturn12file0L82-L92

---

## 2) Phase 2.2 — Symbol Resolution + Expansion Cache (what was built)

### 2.1 Resolver contract (API + behavior)

Phase 2.2 completion report states:

- Resolver API implemented: `resolve(symbol_id, slice, run_id) -> payload` returning `(payload, cache_hit)`
- Supported slice forms: `lines[a:b]`, `chars[a:b]`, `head(n)`, `tail(n)`
- `slice=ALL` explicitly denied via SliceResolver
- `run_id` required for caching fileciteturn12file2L61-L73 fileciteturn12file2L83-L93

### 2.2 Expansion cache design

**Cache key**: `(run_id, symbol_id, slice, section_content_hash)` (per report) fileciteturn12file1L79-L86

**Substrates**
- Primary: SQLite (`system1.db`)
- Fallback: JSONL (`CORTEX/_generated/expansion_cache.jsonl`) fileciteturn12file2L96-L101

**SQLite schema (expansion_cache table)** is defined in the report, including PK across `(run_id, symbol_id, slice, section_id)` and the stored hashes, bytes, and timestamps. fileciteturn12file2L102-L113

### 2.3 CLI integration for resolution

- `catalytic_chat/cli.py` updated with a `resolve` command:
  - `cortex resolve @Symbol --slice "<expr>" --run-id <id>` fileciteturn12file2L53-L58

### 2.4 Files created/modified for Phase 2.2

From the Phase 2.2 completion report:

**New**
- `catalytic_chat/symbol_resolver.py`
  - `SymbolResolver` class
  - `ExpansionCacheEntry` dataclass
  - SQLite expansion_cache
  - JSONL fallback
  - Cache hit detection without re-expansion fileciteturn12file2L41-L50

**Modified**
- `catalytic_chat/__init__.py` exports `SymbolResolver`, `ExpansionCacheEntry`, `resolve_symbol` fileciteturn12file2L51-L55
- `catalytic_chat/cli.py` adds `resolve` fileciteturn12file2L55-L58

### 2.5 Phase 2.2 status note (historical)

The Phase 2.2 report notes: “CORE COMPLETE (testing blocked by environment issue)” at that time. fileciteturn12file2L23-L36

---

## 3) Phase 2 follow-up hardening that directly affected Phase 2 (path/DB unification)

After Phase 2 features existed, your system hit a practical breakage: Phase 2 tables and artifacts were being created/read from **different DB paths** depending on module and working directory. The handoff documents and subsequent changes unified this so Phase 2 works consistently.

### 3.1 Observed breakages (before the fix)

- `symbols list` failing with **no such table: symbols**
- `build` writing `0 sections` and/or writing DB to a different folder than expected
- `SECTION_INDEX.json` missing from expected location fileciteturn12file5L11-L17

### 3.2 Canonical substrate invariants established

Canonical locations declared:

- `CORTEX/_generated/system1.db`
- `CORTEX/_generated/system3.db`
- `CORTEX/_generated/SECTION_INDEX.json`
- Optional JSONL: `CORTEX/_generated/*.jsonl` fileciteturn12file6L6-L16

Schema auto-init requirement when connecting:
- system1 must contain: `sections`, `section_index`, `symbols`, `expansion_cache` fileciteturn12file6L12-L15

### 3.3 Implemented canonical path helpers used by Phase 2 modules

Handoff mandates `catalytic_chat/paths.py` with helpers like:
- `get_cortex_dir(repo_root)` -> `CORTEX/_generated`
- `get_system1_db(repo_root)` / `get_system3_db(repo_root)` fileciteturn12file7L63-L67

These helpers are used by Phase 2 modules (registry + resolver). fileciteturn12file7L69-L74

---

## 4) Concrete “what changed” list (granular checklist)

### Phase 2.1 delivered
- SYMBOLS artifact mapping `@Symbol -> section_id` + namespace conventions. fileciteturn12file1L16-L19
- Dual substrate implementation (SQLite + JSONL) for symbols. fileciteturn12file3L17-L20
- Fail-closed validations:
  - `@` prefix, uniqueness, target exists, default_slice bounded and not ALL. fileciteturn12file0L7-L12 fileciteturn12file0L25-L32
- Deterministic ordering for `list`. fileciteturn12file3L96-L101
- CLI: `symbols add|get|list|verify`. fileciteturn12file1L20-L25

### Phase 2.2 delivered
- `SymbolResolver` bounded resolution API + `(payload, cache_hit)` return. fileciteturn12file2L83-L93
- Slice support and `ALL` rejection. fileciteturn12file2L63-L70
- Expansion cache with per-run reuse and deterministic keying. fileciteturn12file2L96-L101
- Expansion cache schema defined and enforced via SQLite primary key. fileciteturn12file2L102-L113
- CLI command: `resolve @Symbol --slice ... --run-id ...`. fileciteturn12file2L55-L58
- Exports in `__init__.py`. fileciteturn12file2L51-L55

### Phase 2 operationalization (post-phase but required for real use)
- Canonical DB paths unified so Phase 2 tables are always created/read from the same system1.db. fileciteturn12file6L6-L16
- Schema init on connect for `symbols` and `expansion_cache` required for fail-closed behavior. fileciteturn12file6L12-L15

---

## 5) What Phase 2 intentionally did NOT do (by design)

- Allow unbounded `ALL` slicing (explicitly forbidden everywhere). fileciteturn12file2L69-L70
- Support other `target_type` values beyond `SECTION` (Phase 2.1 is explicitly constrained). fileciteturn12file3L11-L12
- Introduce planner ops or message cassette behavior (those are Phase 3+). (Context only: Phase 2 stays in symbols + expansion cache.)

---

## 6) Pointers for audit (where Phase 2 is documented in the combined artifact)

- `docs/catalytic-chat/phases/PHASE_2_1.md` (checklists, CLI surface) fileciteturn12file1L14-L25
- `docs/catalytic-chat/phases/PHASE_2_2.md` (completion report, schema, behavior) fileciteturn12file2L18-L36
- `catalytic_chat/symbol_registry.py` (actual implementation) fileciteturn12file4L18-L27
- `catalytic_chat/symbol_resolver.py` (resolver + cache implementation; described in report) fileciteturn12file2L41-L50
- Path/DB unification handoff (Phase 2 operational correctness) fileciteturn12file5L19-L24

---

## 7) Evidence limitation

The opncd.ai share link was not retrievable from this environment (`(400) OK`). This report therefore reflects **everything Phase 2 did that is present in your uploaded CAT_CHAT artifacts**.
