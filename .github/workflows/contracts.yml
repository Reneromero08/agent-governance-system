name: Contracts

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  governance:
    name: Governance Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need history for diff checks
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
      
      - name: Build cortex index
        run: python CORTEX/cortex.build.py
      
      - name: Run canon governance checks
        run: python TOOLS/check_canon_governance.py
      
      - name: Run critic checks
        run: python TOOLS/critic.py

      - name: Lint tokens
        run: python TOOLS/lint_tokens.py

      - name: Run contract fixtures
        run: python CONTRACTS/runner.py
      
      - name: Run artifact escape hatch
        run: |
          cd SKILLS/artifact-escape-hatch
          python run.py fixtures/basic/input.json ../../CONTRACTS/_runs/escape-check.json
          python validate.py ../../CONTRACTS/_runs/escape-check.json fixtures/basic/expected.json
